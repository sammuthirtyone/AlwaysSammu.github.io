<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kitty Coin Catcher</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Fredoka', cursive, sans-serif; }

        body {
            background: #ffecf2;
            background-image: 
                radial-gradient(circle at 10% 20%, #fff0f6 10%, transparent 20%),
                radial-gradient(circle at 90% 80%, #e3f2fd 15%, transparent 25%),
                linear-gradient(135deg, #ffd6e7 0%, #fff5e6 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* --- MAIN CARD --- */
        .game-card {
            width: 100%; max-width: 500px; height: 100vh; max-height: 850px;
            background: rgba(255, 255, 255, 0.45); backdrop-filter: blur(15px);
            border-radius: 40px;
            box-shadow: 0 20px 40px rgba(255, 182, 193, 0.4), inset 0 0 0 2px rgba(255, 255, 255, 0.6);
            position: relative; display: flex; flex-direction: column; padding: 15px; overflow: hidden;
        }

        @media (max-width: 500px) {
            .game-card { border-radius: 0; height: 100vh; max-height: 100vh; }
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 40px; transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 20; pointer-events: auto; background: rgba(255,255,255,0.95);
            padding: 20px;
        }
        .hidden { opacity: 0; pointer-events: none; transform: scale(0.95); z-index: 0; }

        /* TEXT STYLES */
        .game-title { font-size: 3.5rem; color: #ff8fa3; text-shadow: 4px 4px 0px #fff, 6px 6px 0px #ffc2d1; text-align: center; line-height: 0.9; margin-bottom: 10px; }
        .game-desc { color: #6d597a; margin-bottom: 20px; text-align: center; background: #fff; padding: 10px 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* --- BUTTONS --- */
        .btn-cute {
            background: linear-gradient(to bottom, #ffbcd9, #ff8fa3); border: none; padding: 15px 40px;
            border-radius: 50px; font-size: 1.5rem; color: white; font-weight: 700; cursor: pointer;
            box-shadow: 0 6px 0 #e06c85, 0 10px 20px rgba(255, 143, 163, 0.4);
            transition: transform 0.1s, box-shadow 0.1s; margin: 5px; width: 80%;
        }
        .btn-cute:active { transform: translateY(6px); box-shadow: 0 0 0 #e06c85; }
        
        .btn-shop {
            background: linear-gradient(to bottom, #bde0fe, #a2d2ff); box-shadow: 0 6px 0 #89c2fa;
            font-size: 1.2rem; padding: 12px 30px; margin-top: 10px;
        }
        .btn-shop:active { box-shadow: 0 0 0 #89c2fa; transform: translateY(6px); }

        .btn-close {
            position: absolute; top: 20px; right: 20px; background: #ff5d8f; width: 40px; height: 40px;
            border-radius: 50%; border: none; color: white; font-weight: bold; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 3px 0 #c9184a;
        }
        .btn-close:active { transform: translateY(3px); box-shadow: none; }

        /* --- HUD --- */
        .hud { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; position: relative; z-index: 15; }
        .stats-box { display: flex; gap: 10px; }
        .pill {
            background: #fff; padding: 8px 16px; border-radius: 30px; color: #6d597a; font-weight: 700;
            box-shadow: 0 4px 0 #ffe0e9; display: flex; align-items: center; gap: 8px; font-size: 1.1rem;
        }
        .hearts-container { color: #ff5d8f; letter-spacing: 2px; font-size: 1.4rem; }

        /* --- CANVAS --- */
        .canvas-container {
            flex: 1; width: 100%; background: linear-gradient(180deg, #e0f7fa 0%, #fff3e0 100%);
            border-radius: 25px; border: 6px solid #fff; box-shadow: inset 0 5px 10px rgba(0,0,0,0.05);
            position: relative; overflow: hidden; touch-action: none; cursor: none;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* --- SHOP UI --- */
        .shop-header { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 20px; margin-top: 40px;}
        .shop-wallet { background: #ffcf56; color: #fff; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 1.2rem; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); border: 2px solid #fff; box-shadow: 0 3px 0 #e6b744; }
        
        .shop-tabs { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #fff; border-radius: 15px; font-weight: bold; color: #aaa; cursor: pointer; transition: 0.2s; box-shadow: 0 3px 0 #eee; }
        .tab-btn.active { background: #ff8fa3; color: white; box-shadow: 0 3px 0 #e06c85; transform: translateY(1px); }

        .shop-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%;
            overflow-y: auto; padding-bottom: 20px; max-height: 400px;
        }
        .shop-item {
            background: #fff; border-radius: 20px; padding: 15px; text-align: center;
            border: 2px solid transparent; transition: 0.2s; position: relative;
            box-shadow: 0 4px 0 #eee;
        }
        .shop-item:active { transform: translateY(4px); box-shadow: none; }
        .shop-item.selected { border-color: #ff5d8f; background: #fff0f6; }
        .shop-item.locked { opacity: 0.7; filter: grayscale(0.8); }
        .shop-icon { font-size: 2.5rem; margin-bottom: 5px; display: block; }
        .item-name { font-size: 0.9rem; font-weight: bold; color: #6d597a; display: block; margin-bottom: 5px; }
        .item-cost { 
            background: #eee; padding: 5px 10px; border-radius: 10px; font-size: 0.8rem; 
            font-weight: bold; color: #555; display: inline-block; 
        }
        .item-cost.can-afford { background: #d1fae5; color: #065f46; }
        .owned-badge { font-size: 0.8rem; color: #ff5d8f; font-weight: bold; }

        /* FX */
        .combo-text {
            position: absolute; pointer-events: none; font-weight: 800; font-size: 1.5rem;
            text-shadow: 2px 2px 0 #fff; animation: floatUp 0.8s forwards; z-index: 10;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }
    </style>
</head>
<body>

    <div class="game-card" id="gameCard">
        
        <div class="hud">
            <div class="stats-box">
                <div class="pill">
                    <span>ü™ô</span> <span id="runScore">0</span>
                </div>
                <div class="pill hearts-container" id="heartsDisplay">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>
            <div class="pill" id="powerupInd" style="display:none; color:#4cc9f0;">
                üß≤ <span id="powerTime">5s</span>
            </div>
            <div class="pill" id="comboPill" style="display:none; color:#ff9f1c;">
                üî• <span id="comboVal">x1</span>
            </div>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <canvas id="gameCanvas"></canvas>
        </div>
        <div class="footer-hint" style="text-align:center; color:#b0aac0; margin-top:8px; font-size: 0.9rem;">
            üëÜ Drag to catch! Coins are saved automatically!
        </div>

        <div class="screen start-screen" id="startScreen">
            <div style="font-size: 5rem; margin-bottom: 10px; animation: bounce 2s infinite;" id="heroCat">üê±</div>
            <div class="game-title">KITTY<br>MARKET<br>DX</div>
            <div class="game-desc">
                Catch coins to buy skins! üõçÔ∏è<br>
                Avoid bombs! üí£<br>
                Grab powerups! üß≤
            </div>
            <button class="btn-cute" id="startBtn">PLAY ‚ñ∂</button>
            <button class="btn-cute btn-shop" id="openShopBtn">üõí SHOP</button>
        </div>

        <div class="screen hidden" id="shopScreen">
            <div class="shop-header">
                <h2 style="color:#6d597a;">Marketplace</h2>
                <div class="shop-wallet">ü™ô <span id="walletVal">0</span></div>
            </div>
            <button class="btn-close" id="closeShopBtn">‚úï</button>
            
            <div class="shop-tabs">
                <button class="tab-btn active" id="tabSkins" onclick="switchTab('skins')">Skins</button>
                <button class="tab-btn" id="tabUpgrades" onclick="switchTab('upgrades')">Upgrades</button>
            </div>

            <div class="shop-grid" id="shopGrid">
                </div>
        </div>

        <div class="screen hidden" id="gameOverScreen">
            <h2 style="color:#ff5d8f; font-size: 3rem; margin-bottom: 5px;">Ouch! ü§ï</h2>
            <div style="color: #6d597a; font-size: 1.2rem;">Coins Collected</div>
            <div style="font-size: 4rem; color: #ffcf56; text-shadow: 2px 2px 0 #bfa04d; font-weight:800;" id="finalScore">0</div>
            
            <div style="background:#fff; padding:10px 20px; border-radius:15px; margin: 10px 0; color:#555; box-shadow: 0 4px 0 #eee;">
                Total Bank: ü™ô <span id="totalBankDisplay">0</span>
            </div>

            <div id="highScoreTag" style="color:#ffcf56; font-weight:bold; margin-bottom:15px; font-size: 1.2rem;"></div>
            <button class="btn-cute" id="restartBtn">Play Again üîÑ</button>
            <button class="btn-cute btn-shop" id="goShopFromOver">üõí Spend Coins</button>
        </div>

    </div>

    <script>
        /**
         * Kitty Coin Catcher
         * Fully functional single-file game.
         */
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        
        // --- DATA & SAVES ---
        const DEFAULT_DATA = {
            coins: 0,
            highScore: 0,
            inventory: ['skin_default'],
            equippedSkin: 'skin_default',
            upgrades: {
                width: 0, // Level 0-5
                luck: 0   // Level 0-5
            }
        };

        let playerData = loadData();

        function loadData() {
            try {
                const saved = localStorage.getItem('kittyMarketSave_v1');
                if(saved) return { ...DEFAULT_DATA, ...JSON.parse(saved) };
            } catch(e) { console.error("Save error", e); }
            return JSON.parse(JSON.stringify(DEFAULT_DATA));
        }

        function saveData() {
            localStorage.setItem('kittyMarketSave_v1', JSON.stringify(playerData));
            updateWalletUI();
        }

        // --- GAME CONFIGURATION ---
        const ITEMS_DB = {
            skins: [
                { id: 'skin_default', name: 'Classic', price: 0, icon: 'üê±', colors: { body: '#fcd5ce', stroke: '#e5989b', face: '#6d597a' } },
                { id: 'skin_void', name: 'Void', price: 200, icon: 'üêà‚Äç‚¨õ', colors: { body: '#2d3436', stroke: '#000', face: '#ffffff' } },
                { id: 'skin_tabby', name: 'Garfy', price: 500, icon: 'üêØ', colors: { body: '#ffaa5e', stroke: '#d35400', face: '#5e3023' } },
                { id: 'skin_pink', name: 'Berry', price: 1000, icon: 'üçì', colors: { body: '#ff70a6', stroke: '#d90429', face: '#fff' } },
                { id: 'skin_alien', name: 'Gnarp', price: 2500, icon: 'üëΩ', colors: { body: '#70e000', stroke: '#38b000', face: '#004b23' } },
                { id: 'skin_robo', name: 'Mecha', price: 5000, icon: 'ü§ñ', colors: { body: '#adb5bd', stroke: '#495057', face: '#0dcaf0' } },
            ],
            upgrades: [
                { id: 'upg_width', name: 'Big Basket', price: (lvl) => (lvl+1)*300, max: 5, desc: 'Catches items easier!' },
                { id: 'upg_luck', name: 'Lucky Cat', price: (lvl) => (lvl+1)*500, max: 3, desc: 'More powerups & hearts!' }
            ]
        };

        // --- DOM ELEMENTS ---
        const screens = {
            start: document.getElementById('startScreen'),
            gameover: document.getElementById('gameOverScreen'),
            shop: document.getElementById('shopScreen')
        };
        const ui = {
            score: document.getElementById('runScore'),
            finalScore: document.getElementById('finalScore'),
            hearts: document.getElementById('heartsDisplay'),
            comboPill: document.getElementById('comboPill'),
            comboVal: document.getElementById('comboVal'),
            powerPill: document.getElementById('powerupInd'),
            powerTime: document.getElementById('powerTime'),
            card: document.getElementById('gameCard'),
            container: document.getElementById('canvasContainer'),
            wallet: document.getElementById('walletVal'),
            shopGrid: document.getElementById('shopGrid'),
            totalBank: document.getElementById('totalBankDisplay'),
            heroCat: document.getElementById('heroCat')
        };

        // --- STATE VARIABLES ---
        let width, height;
        let gameState = 'START';
        let runScore = 0;
        let lives = 3;
        let combo = 0;
        
        // Physics
        let mouseX = 0;
        let basketX = 0;
        let targetX = 0;
        let baseBasketWidth = 90;
        let currentBasketWidth = 90;
        
        // Game Loop
        let gameFrame = 0;
        let items = [];
        let particles = [];
        let reqAnimId;
        
        // Powerups
        let magnetTimer = 0;
        let shieldActive = false;

        // Audio
        let audioCtx;
        let isMuted = false;

        // --- SETUP & RESIZE ---
        function resize() {
            const rect = ui.container.getBoundingClientRect();
            // High DPI Canvas
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            
            width = rect.width;
            height = rect.height;

            if(gameState === 'START') {
                targetX = (width - currentBasketWidth) / 2;
                basketX = targetX;
            }
        }
        window.addEventListener('resize', resize);
        
        // Initial setup
        updateWalletUI();
        updateHeroCat();
        
        // Wait for fonts to load slightly or just init
        setTimeout(resize, 100);

        // --- SHOP SYSTEM ---
        function updateWalletUI() {
            ui.wallet.innerText = playerData.coins;
            ui.totalBank.innerText = playerData.coins;
        }

        function updateHeroCat() {
            const skin = ITEMS_DB.skins.find(s => s.id === playerData.equippedSkin);
            ui.heroCat.innerText = skin ? skin.icon : 'üê±';
        }

        let currentTab = 'skins';
        window.switchTab = (tab) => {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(tab === 'skins') document.getElementById('tabSkins').classList.add('active');
            else document.getElementById('tabUpgrades').classList.add('active');
            renderShop();
        };

        function renderShop() {
            ui.shopGrid.innerHTML = '';
            
            if(currentTab === 'skins') {
                ITEMS_DB.skins.forEach(item => {
                    const owned = playerData.inventory.includes(item.id);
                    const equipped = playerData.equippedSkin === item.id;
                    const canAfford = playerData.coins >= item.price;
                    
                    const el = document.createElement('div');
                    el.className = `shop-item ${equipped ? 'selected' : ''} ${!owned && !canAfford ? 'locked' : ''}`;
                    el.onclick = () => handleBuySkin(item);
                    
                    let btnHTML = '';
                    if(equipped) btnHTML = '<span class="owned-badge">EQUIPPED</span>';
                    else if(owned) btnHTML = '<span class="owned-badge" style="color:#aaa">OWNED</span>';
                    else btnHTML = `<span class="item-cost ${canAfford ? 'can-afford' : ''}">ü™ô ${item.price}</span>`;

                    el.innerHTML = `
                        <span class="shop-icon">${item.icon}</span>
                        <span class="item-name">${item.name}</span>
                        ${btnHTML}
                    `;
                    ui.shopGrid.appendChild(el);
                });
            } else {
                ITEMS_DB.upgrades.forEach(item => {
                    const key = item.id.replace('upg_', '');
                    const level = playerData.upgrades[key];
                    const price = item.price(level);
                    const isMax = level >= item.max;
                    const canAfford = !isMax && playerData.coins >= price;

                    const el = document.createElement('div');
                    el.className = `shop-item ${isMax ? 'locked' : ''}`;
                    if(!isMax) el.onclick = () => handleBuyUpgrade(item);

                    el.innerHTML = `
                        <span class="shop-icon">üÜô</span>
                        <span class="item-name">${item.name} <span style="color:#ff5d8f">Lvl ${level}</span></span>
                        <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">${item.desc}</div>
                        ${isMax ? '<span class="owned-badge">MAXED</span>' : `<span class="item-cost ${canAfford ? 'can-afford' : ''}">ü™ô ${price}</span>`}
                    `;
                    ui.shopGrid.appendChild(el);
                });
            }
        }

        function handleBuySkin(item) {
            if(playerData.inventory.includes(item.id)) {
                playerData.equippedSkin = item.id;
                playSound('select');
            } else {
                if(playerData.coins >= item.price) {
                    playerData.coins -= item.price;
                    playerData.inventory.push(item.id);
                    playerData.equippedSkin = item.id;
                    playSound('buy');
                } else {
                    playSound('miss');
                    return; 
                }
            }
            saveData();
            renderShop();
            updateHeroCat();
        }

        function handleBuyUpgrade(item) {
            const key = item.id.replace('upg_', '');
            const level = playerData.upgrades[key];
            const price = item.price(level);
            
            if(level < item.max && playerData.coins >= price) {
                playerData.coins -= price;
                playerData.upgrades[key]++;
                playSound('buy');
                saveData();
                renderShop();
            } else {
                playSound('miss');
            }
        }

        // --- AUDIO ENGINE ---
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if (isMuted) return;
            // Only try to init if user interacted
            if (!audioCtx) return; 

            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'coin') {
                osc.type = 'sine';
                // Pitch rises with combo
                osc.frequency.setValueAtTime(800 + (combo * 50), t);
                osc.frequency.exponentialRampToValueAtTime(1400, t + 0.1);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.15);
                osc.start(t); osc.stop(t + 0.15);
            } 
            else if (type === 'buy') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, t);
                osc.frequency.linearRampToValueAtTime(800, t+0.1);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.3);
                osc.start(t); osc.stop(t+0.3);
            }
            else if (type === 'bomb') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.exponentialRampToValueAtTime(50, t + 0.4);
                gain.gain.setValueAtTime(0.2, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.4);
                osc.start(t); osc.stop(t + 0.4);
            } else if (type === 'powerup') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(600, t);
                osc.frequency.linearRampToValueAtTime(1200, t + 0.2);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.3);
                osc.start(t); osc.stop(t + 0.3);
            } else if (type === 'select') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, t);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.1);
                osc.start(t); osc.stop(t + 0.1);
            }
        }

        // --- GAME LOGIC ---

        function initGame() {
            initAudio();
            resize(); // Ensure size is correct
            
            runScore = 0;
            lives = 3;
            combo = 0;
            items = [];
            particles = [];
            magnetTimer = 0;
            shieldActive = false;
            gameFrame = 0;
            
            // Apply Upgrades
            currentBasketWidth = baseBasketWidth + (playerData.upgrades.width * 15);
            
            // Set basket pos
            targetX = (width - currentBasketWidth) / 2;
            basketX = targetX;

            updateUI();
            
            screens.start.classList.add('hidden');
            screens.gameover.classList.add('hidden');
            screens.shop.classList.add('hidden');
            
            gameState = 'PLAYING';
            loop();
        }

        function updateUI() {
            ui.score.innerText = runScore;
            
            let hStr = '';
            for(let i=0; i<3; i++) hStr += i < lives ? '‚ù§Ô∏è' : 'üñ§';
            if(shieldActive) hStr = 'üõ°Ô∏è' + hStr; 
            ui.hearts.innerText = hStr;

            if(combo > 1) {
                ui.comboPill.style.display = 'flex';
                ui.comboVal.innerText = 'x' + combo;
                ui.comboPill.style.transform = `scale(${1 + (Math.min(combo, 10)*0.05)})`;
            } else {
                ui.comboPill.style.display = 'none';
            }

            if(magnetTimer > 0) {
                ui.powerPill.style.display = 'flex';
                ui.powerTime.innerText = Math.ceil(magnetTimer/60) + 's';
            } else {
                ui.powerPill.style.display = 'none';
            }
        }

        function spawnItem() {
            const luckMod = playerData.upgrades.luck * 0.005; 
            const roll = Math.random();
            let type = 'coin';
            let speed = 3 + (gameFrame/1500); // Speed curve

            if (lives < 3 && roll > (0.98 - luckMod)) {
                type = 'heart'; speed *= 1.3;
            } else if (roll > (0.97 - luckMod)) {
                type = Math.random() > 0.5 ? 'magnet' : 'shield';
                speed *= 1.2;
            } else if (roll < 0.3) {
                type = 'bomb'; speed *= 0.9;
            }
            
            const margin = 30;
            items.push({
                x: Math.random() * (width - margin*2) + margin,
                y: -40,
                type: type,
                speed: speed,
                rot: 0,
                rotSpeed: (Math.random() - 0.5) * 0.2
            });
        }

        function gameOver() {
            gameState = 'GAMEOVER';
            
            playerData.coins += runScore;
            if(runScore > playerData.highScore) playerData.highScore = runScore;
            saveData();

            ui.finalScore.innerText = runScore;
            
            if (runScore >= playerData.highScore && runScore > 0) {
                document.getElementById('highScoreTag').innerText = "‚ú® NEW BEST! ‚ú®";
            } else {
                document.getElementById('highScoreTag').innerText = "Best: " + playerData.highScore;
            }

            screens.gameover.classList.remove('hidden');
        }

        function drawBasket(x, y) {
            const w = currentBasketWidth;
            const h = 50;
            const skin = ITEMS_DB.skins.find(s => s.id === playerData.equippedSkin) || ITEMS_DB.skins[0];

            // FX Rings
            if(magnetTimer > 0) {
                ctx.strokeStyle = `rgba(76, 201, 240, ${(Math.sin(gameFrame*0.2)+1)/2})`;
                ctx.lineWidth = 4;
                ctx.beginPath(); ctx.arc(x+w/2, y+20, w, 0, Math.PI*2); ctx.stroke();
            }
            if(shieldActive) {
                ctx.strokeStyle = `rgba(255, 209, 102, 0.8)`;
                ctx.lineWidth = 3;
                ctx.beginPath(); ctx.arc(x+w/2, y+20, w*0.8, 0, Math.PI*2); ctx.stroke();
            }

            // Body
            ctx.fillStyle = skin.colors.body;
            ctx.strokeStyle = skin.colors.stroke;
            ctx.lineWidth = 3;

            // Handle
            ctx.beginPath(); ctx.arc(x + w/2, y, w/2 - 5, Math.PI, 0); ctx.stroke();

            // Box
            ctx.beginPath(); ctx.roundRect(x, y, w, h, 15); ctx.fill(); ctx.stroke();

            // Face (Cat)
            ctx.fillStyle = skin.colors.face;
            ctx.beginPath(); 
            // Eye logic: Look at nearest falling item
            let lookX = 0;
            let nearestY = -1000;
            items.forEach(it => { 
                if(it.y > nearestY && it.y < y+50) {
                    nearestY = it.y;
                    lookX = (it.x - (x+w/2)) / 10;
                }
            });
            lookX = Math.max(-8, Math.min(8, lookX)); // Clamp look

            ctx.arc(x + 30 + lookX, y + 20, 4, 0, Math.PI*2); // Eye L
            ctx.arc(x + w - 30 + lookX, y + 20, 4, 0, Math.PI*2); // Eye R
            ctx.fill();

            // Ears
            ctx.fillStyle = skin.colors.body;
            ctx.beginPath(); ctx.moveTo(x + 10, y); ctx.lineTo(x + 20, y - 15); ctx.lineTo(x + 35, y); ctx.fill(); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(x + w - 35, y); ctx.lineTo(x + w - 20, y - 15); ctx.lineTo(x + w - 10, y); ctx.fill(); ctx.stroke();
        }

        function loop() {
            if (gameState !== 'PLAYING') return;
            
            // Clean slate
            ctx.clearRect(0, 0, width, height);
            
            gameFrame++;
            if (magnetTimer > 0) magnetTimer--;

            // Spawn logic
            let spawnRate = Math.max(20, 60 - Math.floor(gameFrame/300));
            if (gameFrame % spawnRate === 0) spawnItem();

            // Move Basket
            basketX += (targetX - basketX) * 0.2;
            const basketY = height - 90; // Fixed offset from bottom
            drawBasket(basketX, basketY);

            // Process Items
            for (let i = items.length - 1; i >= 0; i--) {
                let p = items[i];
                
                // Magnet Pull
                if (magnetTimer > 0 && p.type === 'coin') {
                    p.x += (basketX + currentBasketWidth/2 - p.x) * 0.15;
                    p.y += 5; 
                } else {
                    p.y += p.speed;
                }
                
                p.rot += p.rotSpeed;

                // Draw Item
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rot);
                
                if (p.type === 'coin') {
                    ctx.beginPath(); ctx.arc(0, 0, 16, 0, Math.PI*2);
                    ctx.fillStyle = '#ffcf56'; ctx.fill();
                    ctx.lineWidth=2; ctx.strokeStyle='#fff'; ctx.stroke();
                    ctx.fillStyle='#eebb4d'; ctx.font='16px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('üç¨', 0, 1);
                } else if (p.type === 'bomb') {
                    ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0, 5, 14, 0, Math.PI*2); ctx.fill();
                    ctx.font='20px Arial'; ctx.textAlign='center'; ctx.fillText('‚ò†Ô∏è', 0, 8);
                } else if (p.type === 'magnet') {
                    ctx.shadowBlur=15; ctx.shadowColor='#4cc9f0';
                    ctx.font='30px Arial'; ctx.textAlign='center'; ctx.fillText('üß≤', 0, 5);
                } else if (p.type === 'shield') {
                    ctx.shadowBlur=15; ctx.shadowColor='#ffd166';
                    ctx.font='30px Arial'; ctx.textAlign='center'; ctx.fillText('üõ°Ô∏è', 0, 5);
                } else { // Heart
                    ctx.shadowBlur=15; ctx.shadowColor='#ff5d8f';
                    ctx.font='30px Arial'; ctx.textAlign='center'; ctx.fillText('üíñ', 0, 5);
                }
                ctx.restore();

                // Collision Detection (AABB approx)
                if (p.y > basketY && p.y < basketY + 40 && p.x > basketX - 10 && p.x < basketX + currentBasketWidth + 10) {
                    
                    if (p.type === 'coin') {
                        runScore += (10 + combo * 2);
                        combo++;
                        playSound('coin');
                        createFloatingText(p.x, p.y, `+${10+combo*2}`, "#ff8fa3");
                        createParticles(p.x, p.y, '#ffcf56');
                    } else if (p.type === 'bomb') {
                        if(shieldActive) {
                            shieldActive = false;
                            playSound('powerup');
                            createFloatingText(p.x, p.y, "BLOCKED!", "#4cc9f0");
                        } else {
                            lives--;
                            combo = 0;
                            playSound('bomb');
                            ui.card.classList.remove('shake');
                            void ui.card.offsetWidth; // trigger reflow
                            ui.card.classList.add('shake');
                            
                            // Red flash
                            ctx.fillStyle = 'rgba(255,0,0,0.3)'; ctx.fillRect(0,0,width,height);
                            
                            if(lives <= 0) {
                                gameOver();
                                return; // Stop loop immediately
                            }
                        }
                    } else if (p.type === 'magnet') {
                        magnetTimer = 600; // ~10 seconds at 60fps
                        playSound('powerup');
                        createFloatingText(p.x, p.y, "MAGNET!", "#4cc9f0");
                    } else if (p.type === 'shield') {
                        shieldActive = true;
                        playSound('powerup');
                        createFloatingText(p.x, p.y, "SHIELD!", "#ffd166");
                    } else if (p.type === 'heart') {
                        if(lives<3) lives++;
                        runScore+=50;
                        playSound('powerup');
                        createFloatingText(p.x, p.y, "HP UP!", "#ff5d8f");
                    }
                    
                    updateUI();
                    items.splice(i, 1);
                    continue;
                }

                // Despawn
                if (p.y > height) {
                    if(p.type === 'coin') {
                        combo = 0;
                        updateUI();
                    }
                    items.splice(i, 1);
                }
            }

            // Particles update
            for (let i = particles.length - 1; i >= 0; i--) {
                let pt = particles[i];
                pt.x += pt.vx; pt.y += pt.vy; pt.life -= 0.05;
                ctx.globalAlpha = pt.life;
                ctx.fillStyle = pt.color;
                ctx.beginPath(); ctx.arc(pt.x, pt.y, 5, 0, Math.PI*2); ctx.fill();
                if (pt.life <= 0) particles.splice(i, 1);
            }
            ctx.globalAlpha = 1.0;

            reqAnimId = requestAnimationFrame(loop);
        }

        // --- VISUAL FX UTILS ---
        function createParticles(x, y, color) {
            for(let i=0; i<8; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 1.0, color: color
                });
            }
        }
        function createFloatingText(x, y, text, color) {
            const el = document.createElement('div');
            el.className = 'combo-text';
            el.innerText = text;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            el.style.color = color;
            ui.container.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        // --- INPUT HANDLING ---
        function handleInput(e) {
            if (gameState !== 'PLAYING') return;
            
            // Prevent scroll
            if(e.type === 'touchmove' || e.type === 'touchstart') e.preventDefault();

            // Get pointer X relative to canvas
            const rect = canvas.getBoundingClientRect();
            // We use clientX. If touch, use first touch.
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            
            // Map clientX to canvas coordinates
            // (clientX - rect.left) gives pixels from left edge of canvas
            let pos = (clientX - rect.left);
            
            // Center basket on finger
            pos -= currentBasketWidth / 2;

            // Clamp
            if (pos < 0) pos = 0;
            if (pos > width - currentBasketWidth) pos = width - currentBasketWidth;

            targetX = pos;
        }

        ui.container.addEventListener('mousemove', handleInput);
        ui.container.addEventListener('touchmove', handleInput, { passive: false });
        ui.container.addEventListener('touchstart', handleInput, { passive: false });

        // --- BUTTON BINDINGS ---
        document.getElementById('startBtn').addEventListener('click', () => {
            playSound('select');
            initGame();
        });

        document.getElementById('restartBtn').addEventListener('click', () => {
            playSound('select');
            initGame();
        });

        document.getElementById('openShopBtn').addEventListener('click', () => {
            playSound('select');
            screens.shop.classList.remove('hidden');
            renderShop();
        });

        document.getElementById('goShopFromOver').addEventListener('click', () => {
            playSound('select');
            screens.gameover.classList.add('hidden');
            screens.start.classList.remove('hidden');
            screens.shop.classList.remove('hidden');
            renderShop();
        });

        document.getElementById('closeShopBtn').addEventListener('click', () => {
            playSound('select');
            screens.shop.classList.add('hidden');
            updateHeroCat();
        });

        // Animation for Start Screen Cat
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes bounce {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-20px); }
            }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>
