<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üê± Kitty Coin Catcher Deluxe</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        :root {
            --primary: #ff8fab;
            --secondary: #ffc2d1;
            --accent: #fb6f92;
            --text: #594a4e;
            --bg: #ffe5ec;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Fredoka', sans-serif; }

        body {
            background: var(--bg);
            background-image: radial-gradient(var(--secondary) 15%, transparent 16%);
            background-size: 40px 40px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- GAME CONTAINER --- */
        #game-frame {
            position: relative;
            width: 100%; max-width: 450px;
            height: 100%; max-height: 850px;
            background: rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
            border-radius: 0;
            box-shadow: 0 0 50px rgba(251, 111, 146, 0.2);
            overflow: hidden;
            transition: transform 0.1s;
        }
        @media(min-width: 500px) {
            #game-frame { height: 90vh; border-radius: 40px; border: 8px solid #fff; }
        }

        /* --- LAYERS --- */
        canvas { display: block; width: 100%; height: 100%; cursor: none; }
        
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            z-index: 10;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; transition: all 0.4s ease;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }
        .hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }

        /* --- HUD --- */
        .hud-top {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; width: 100%;
        }
        
        .score-pill {
            background: #fff; padding: 8px 20px; border-radius: 50px;
            font-size: 1.4rem; font-weight: 700; color: var(--text);
            box-shadow: 0 4px 0 var(--secondary);
            display: flex; gap: 10px; align-items: center;
        }

        .pause-btn {
            background: #fff; width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 0 #ddd;
            border: none; color: var(--text); pointer-events: auto;
        }
        .pause-btn:active { transform: translateY(4px); box-shadow: none; }

        /* Fever Bar */
        .fever-container {
            width: 80%; height: 12px; background: rgba(255,255,255,0.5);
            border-radius: 10px; margin: 0 auto; overflow: hidden;
            border: 2px solid #fff; position: relative;
        }
        .fever-fill {
            height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e, #fad0c4);
            transition: width 0.2s;
        }
        .fever-active .fever-fill {
            background: linear-gradient(90deg, #ff0000, #ffa500, #ffff00, #008000, #0000ff, #4b0082, #ee82ee);
            animation: rainbow 1s linear infinite;
        }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        /* --- BUTTONS & TYPOGRAPHY --- */
        h1 {
            font-size: 3.5rem; color: var(--accent);
            text-shadow: 3px 3px 0 #fff, 6px 6px 0 var(--secondary);
            text-align: center; line-height: 1.1; margin-bottom: 20px;
        }

        .btn-big {
            background: linear-gradient(180deg, #ff8fab, #fb6f92);
            color: white; border: none; padding: 15px 50px;
            font-size: 1.8rem; border-radius: 50px; font-weight: 700;
            box-shadow: 0 8px 0 #c9184a, 0 15px 20px rgba(251, 111, 146, 0.4);
            cursor: pointer; transition: transform 0.1s; margin: 10px;
        }
        .btn-big:active { transform: translateY(8px); box-shadow: 0 0 0 #c9184a; }
        
        .btn-icon {
            background: #fff; width: 60px; height: 60px; border-radius: 20px;
            border: none; font-size: 1.8rem; box-shadow: 0 5px 0 #ddd;
            color: var(--text); margin: 0 10px; cursor: pointer;
        }
        .btn-icon:active { transform: translateY(5px); box-shadow: none; }

        /* --- LOADING SCREEN --- */
        .loading-screen { background: var(--primary); color: white; z-index: 50; }
        .loader-cat { font-size: 4rem; animation: bounce 0.6s infinite alternate; }
        .loading-bar {
            width: 200px; height: 10px; background: rgba(255,255,255,0.3);
            border-radius: 10px; margin-top: 20px; overflow: hidden;
        }
        .loading-progress { width: 0%; height: 100%; background: #fff; }
        @keyframes loadAnim { 0% { width: 0%; } 100% { width: 100%; } }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        /* --- SHOP --- */
        .shop-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 20px;
        }
        .shop-item {
            width: 60px; height: 60px; border-radius: 15px; background: #f0f0f0;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
            border: 3px solid transparent; cursor: pointer;
        }
        .shop-item.selected { border-color: var(--accent); background: #ffe5ec; }

        /* --- JUICE EFFECTS --- */
        .float-text {
            position: absolute; font-weight: 900; pointer-events: none;
            text-shadow: 2px 2px 0 #fff; z-index: 15; font-size: 1.5rem;
            animation: floatUp 0.8s forwards;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.8); opacity: 1; }
            50% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-40px) scale(1); opacity: 0; }
        }
        .shake { animation: shakeAnim 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shakeAnim {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }

    </style>
</head>
<body>

<div id="game-frame">
    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer" id="gameUI" style="display:none;">
        <div class="hud-top">
            <button class="pause-btn" onclick="togglePause()">‚è∏Ô∏è</button>
            <div class="score-pill">ü™ô <span id="scoreDisplay">0</span></div>
            <button class="pause-btn" onclick="goHome()">üè†</button>
        </div>
        <div class="fever-container">
            <div class="fever-fill" id="feverBar"></div>
        </div>
        <div style="text-align:center; margin-top: 5px; font-weight:bold; color: var(--accent); text-shadow: 1px 1px 0 #fff;">
            <span id="feverText"></span>
        </div>
    </div>

    <div class="screen" id="startScreen">
        <div style="font-size: 5rem; margin-bottom: 10px;" id="menuCat">üò∫</div>
        <h1>KITTY<br>COIN<br>CATCHER</h1>
        <button class="btn-big" onclick="startLoading()">PLAY ‚ñ∂</button>
        
        <div style="margin-top: 20px; display:flex;">
            <button class="btn-icon" onclick="toggleShop()">üß¢</button>
            <button class="btn-icon" id="muteBtn" onclick="toggleMute()">üîä</button>
        </div>
        <div style="margin-top: 15px; color: #aaa; font-size: 0.9rem;">High Score: <span id="menuHighScore">0</span></div>
    </div>

    <div class="screen hidden" id="shopScreen">
        <h2>Choose a Hat! üß¢</h2>
        <div style="margin-bottom: 10px; color: var(--text);">Total Coins: <span id="bankDisplay">0</span></div>
        <div class="shop-grid" id="shopGrid">
            <div class="shop-item selected">üö´</div>
            <div class="shop-item">üé©</div>
            <div class="shop-item">üëë</div>
        </div>
        <button class="btn-big" onclick="closeShop()">CLOSE</button>
    </div>

    <div class="screen hidden loading-screen" id="loadingScreen">
        <div class="loader-cat">üß∂üêà</div>
        <div class="loading-bar"><div class="loading-progress" id="loadBarFill"></div></div>
        <p style="margin-top: 10px; opacity: 0.8;">Chasing lasers...</p>
    </div>

    <div class="screen hidden" id="pauseScreen">
        <h2 style="font-size: 3rem; color: var(--text); margin-bottom: 20px;">PAUSED</h2>
        <button class="btn-big" onclick="togglePause()">RESUME ‚ñ∂</button>
        <button class="btn-icon" onclick="goHome()" style="margin-top: 10px;">üè†</button>
    </div>

    <div class="screen hidden" id="gameOverScreen">
        <h2 style="font-size: 3rem; color: #ff0000; margin-bottom: 10px;">OH NO! ü•í</h2>
        <div style="font-size: 1.5rem; color: var(--text); margin-bottom: 20px;">Score: <span id="finalScore">0</span></div>
        <button class="btn-big" onclick="startLoading()">RESTART üîÑ</button>
        <button class="btn-icon" onclick="goHome()" style="margin-top: 10px;">üè†</button>
    </div>

</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    const frame = document.getElementById('game-frame');

    // Game State
    let width, height;
    let gameRunning = false;
    let isPaused = false;
    let score = 0;
    let highScore = localStorage.getItem('kittyHighScoreDeluxe') || 0;
    let fever = 0;
    let isFeverMode = false;
    let frameCount = 0;
    let spawnRate = 45;
    let baseSpeed = 4.5;
    
    // Powerup states
    let slowMoTimer = 0;
    let timeModifier = 1.0;

    document.getElementById('menuHighScore').innerText = highScore;

    // Entities
    let player = { x: 0, y: 0, w: 70, h: 60, face: 'happy', mouthOpen: 0 };
    let items = [];
    let particles = [];
    let mouseX = 0;

    // Audio Context
    let audioCtx;
    let isMuted = false;

    // Initialize Audio
    function initAudio() {
        if (!audioCtx && !isMuted) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playSound(type) {
        if (isMuted || !audioCtx) return;
        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'coin') {
            osc.type = 'sine';
            // Pitch goes up as fever goes up!
            let pitchBonus = isFeverMode ? 800 : (fever * 5); 
            osc.frequency.setValueAtTime(800 + pitchBonus, t);
            osc.frequency.exponentialRampToValueAtTime(1200 + pitchBonus, t + 0.1);
            gain.gain.setValueAtTime(0.15, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.15);
            osc.start(t); osc.stop(t + 0.15);
        } else if (type === 'hit') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.linearRampToValueAtTime(40, t + 0.3);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.3);
            osc.start(t); osc.stop(t + 0.3);
        } else if (type === 'powerup') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, t);
            osc.frequency.linearRampToValueAtTime(800, t + 0.2);
            osc.frequency.linearRampToValueAtTime(1200, t + 0.4);
            gain.gain.setValueAtTime(0.15, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.4);
            osc.start(t); osc.stop(t + 0.4);
        }
    }

    // Resize Canvas
    function resize() {
        const rect = frame.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        width = canvas.width;
        height = canvas.height;
        player.y = height - 90;
        if(!gameRunning) player.x = width / 2;
    }
    window.addEventListener('resize', resize);
    resize();

    // Input Handling
    function handleInput(clientX) {
        const rect = frame.getBoundingClientRect();
        let tx = clientX - rect.left;
        mouseX = Math.max(player.w/2, Math.min(width - player.w/2, tx));
    }
    frame.addEventListener('mousemove', e => handleInput(e.clientX));
    frame.addEventListener('touchmove', e => { e.preventDefault(); handleInput(e.touches[0].clientX); }, {passive:false});
    frame.addEventListener('touchstart', e => { 
        initAudio(); 
        handleInput(e.touches[0].clientX); 
    }, {passive:false});
    document.body.addEventListener('click', initAudio, { once: true });

    // --- UI LOGIC ---
    function hideAllScreens() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); }

    function startLoading() {
        initAudio();
        hideAllScreens();
        document.getElementById('loadingScreen').classList.remove('hidden');
        document.getElementById('gameUI').style.display = 'none';
        
        const bar = document.getElementById('loadBarFill');
        bar.style.animation = 'none';
        bar.offsetHeight; 
        bar.style.animation = 'loadAnim 1s ease-out forwards';

        setTimeout(() => { startGame(); }, 1000);
    }

    function toggleMute() {
        isMuted = !isMuted;
        document.getElementById('muteBtn').innerText = isMuted ? 'üîá' : 'üîä';
    }

    function startGame() {
        hideAllScreens();
        document.getElementById('gameUI').style.display = 'flex';
        
        gameRunning = true; isPaused = false;
        score = 0; fever = 0; isFeverMode = false; frameCount = 0;
        items = []; particles = [];
        spawnRate = 45; baseSpeed = 4.5; slowMoTimer = 0; timeModifier = 1.0;
        player.x = width / 2; mouseX = width / 2; player.face = 'happy';
        
        updateUI();
        requestAnimationFrame(gameLoop);
    }

    function togglePause() {
        if (!gameRunning) return;
        isPaused = !isPaused;
        if (isPaused) { document.getElementById('pauseScreen').classList.remove('hidden'); } 
        else { document.getElementById('pauseScreen').classList.add('hidden'); requestAnimationFrame(gameLoop); }
    }

    function goHome() {
        gameRunning = false; isPaused = false;
        hideAllScreens();
        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('startScreen').classList.remove('hidden');
    }

    function toggleShop() { hideAllScreens(); document.getElementById('shopScreen').classList.remove('hidden'); }
    function closeShop() { hideAllScreens(); document.getElementById('startScreen').classList.remove('hidden'); }

    function gameOver() {
        gameRunning = false;
        playSound('hit');
        frame.classList.remove('shake'); void frame.offsetWidth; frame.classList.add('shake');
        
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('kittyHighScoreDeluxe', highScore);
            document.getElementById('menuHighScore').innerText = highScore;
        }
        document.getElementById('finalScore').innerText = score;
        setTimeout(() => {
            document.getElementById('gameUI').style.display = 'none';
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }, 500);
    }

    // --- JUICE FUNCTIONS ---
    function createParticles(x, y, color, count) {
        for(let i=0; i<count; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 12,
                vy: (Math.random() - 0.5) * 12,
                life: 1.0, color: color,
                size: Math.random() * 6 + 3
            });
        }
    }

    function floatText(x, y, txt, color) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.innerText = txt;
        el.style.left = (x + frame.getBoundingClientRect().left - 20) + 'px';
        el.style.top = (y + frame.getBoundingClientRect().top - 20) + 'px';
        el.style.color = color;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    function updateUI() {
        document.getElementById('scoreDisplay').innerText = score;
        document.getElementById('feverBar').style.width = Math.min(fever, 100) + '%';
        
        if (fever >= 100 && !isFeverMode) {
            isFeverMode = true;
            document.getElementById('feverBar').parentElement.classList.add('fever-active');
            document.getElementById('feverText').innerText = "üî• FEVER MODE x2 üî•";
            playSound('powerup');
        } else if (fever <= 0 && isFeverMode) {
            isFeverMode = false;
            document.getElementById('feverBar').parentElement.classList.remove('fever-active');
            document.getElementById('feverText').innerText = "";
        }
    }

    // --- GAME LOGIC ---
    function spawnItem() {
        const r = Math.random();
        let type = 'coin';
        
        if (r > 0.95) type = 'yarn'; 
        else if (r > 0.90) type = 'gem'; 
        else if (r < 0.25) type = 'cucumber'; 

        items.push({
            x: Math.random() * (width - 40) + 20,
            y: -40, type: type,
            rot: Math.random() * Math.PI,
            rotSpeed: (Math.random() - 0.5) * 0.1,
            vy: baseSpeed * (type === 'gem' ? 1.5 : 1) * (type === 'cucumber' ? 1.2 : 1) + Math.random()
        });
    }

    function drawCat(x, y) {
        ctx.save();
        ctx.translate(x, y);

        const bounce = Math.sin(frameCount * 0.15) * 4;
        ctx.translate(0, bounce);

        // Fever glow
        if (isFeverMode) {
            ctx.shadowBlur = 20;
            ctx.shadowColor = `hsl(${(frameCount * 5) % 360}, 100%, 50%)`;
        }

        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.ellipse(0, 20, 45, 35, 0, 0, Math.PI*2); ctx.fill();
        
        // Ears
        ctx.shadowBlur = 0;
        ctx.beginPath(); ctx.moveTo(-35, -5); ctx.lineTo(-45, -35); ctx.lineTo(-15, -10); ctx.fill();
        ctx.beginPath(); ctx.moveTo(35, -5); ctx.lineTo(45, -35); ctx.lineTo(15, -10); ctx.fill();

        ctx.fillStyle = '#ffcfd2';
        ctx.beginPath(); ctx.moveTo(-35, -5); ctx.lineTo(-42, -28); ctx.lineTo(-20, -10); ctx.fill();
        ctx.beginPath(); ctx.moveTo(35, -5); ctx.lineTo(42, -28); ctx.lineTo(20, -10); ctx.fill();

        ctx.fillStyle = '#594a4e';
        if (player.face === 'dead') {
            ctx.font = '24px Fredoka'; ctx.fillText('X', -25, 0); ctx.fillText('X', 10, 0);
        } else {
            ctx.beginPath(); ctx.arc(-20, -5, 5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(20, -5, 5, 0, Math.PI*2); ctx.fill();
        }

        // Dynamic Mouth
        if (player.mouthOpen > 0) {
            ctx.fillStyle = '#ff5d8f';
            ctx.beginPath(); ctx.arc(0, 10, 12, 0, Math.PI*2); ctx.fill();
        } else {
            ctx.strokeStyle = '#594a4e'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(-6, 8, 6, 0, Math.PI); ctx.stroke();
            ctx.beginPath(); ctx.arc(6, 8, 6, 0, Math.PI); ctx.stroke();
        }

        // Paws
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.ellipse(-25, 35, 12, 10, -0.5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(25, 35, 12, 10, 0.5, 0, Math.PI*2); ctx.fill();

        ctx.restore();
    }

    function drawItem(it) {
        ctx.save();
        ctx.translate(it.x, it.y);
        ctx.rotate(it.rot);

        if (it.type === 'coin') {
            ctx.beginPath(); ctx.arc(0,0, 18, 0, Math.PI*2);
            ctx.fillStyle = '#ffca3a'; ctx.fill();
            ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.stroke();
            ctx.font='bold 20px Fredoka'; ctx.fillStyle='#e85d04'; ctx.textAlign='center'; ctx.fillText('$',0,7);
        } else if (it.type === 'cucumber') {
            ctx.fillStyle = '#70e000';
            ctx.beginPath(); ctx.roundRect(-10, -25, 20, 50, 10); ctx.fill();
            ctx.strokeStyle = '#38b000'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(-5, -15); ctx.lineTo(5, -10); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-5, 0); ctx.lineTo(5, 5); ctx.stroke();
        } else if (it.type === 'gem') {
            ctx.fillStyle = '#4cc9f0';
            ctx.beginPath(); ctx.moveTo(0,-15); ctx.lineTo(15,0); ctx.lineTo(0,15); ctx.lineTo(-15,0); ctx.fill();
            ctx.lineWidth=2; ctx.strokeStyle = '#fff'; ctx.stroke();
        } else if (it.type === 'yarn') {
            ctx.fillStyle = '#f72585';
            ctx.beginPath(); ctx.arc(0,0,16,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#fff'; ctx.lineWidth=2; 
            ctx.beginPath(); ctx.moveTo(-10,5); ctx.lineTo(10,-5); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,8); ctx.lineTo(5,-10); ctx.stroke();
        }

        ctx.restore();
    }

    function gameLoop() {
        if (!gameRunning || isPaused) return;
        frameCount++;

        // Slow Mo Logic
        if(slowMoTimer > 0) {
            slowMoTimer--; timeModifier = 0.4;
            ctx.fillStyle = 'rgba(255, 229, 236, 0.3)'; // Trail effect
            ctx.fillRect(0,0,width,height);
        } else {
            timeModifier = 1.0;
            // Draw gradient background
            let bgGradient = ctx.createLinearGradient(0, 0, 0, height);
            bgGradient.addColorStop(0, '#e3f2fd');
            bgGradient.addColorStop(1, '#fff0f5');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0,0,width,height);
        }

        // Difficulty scaling
        if (frameCount % 600 === 0) { baseSpeed += 0.5; spawnRate = Math.max(15, spawnRate - 2); }
        if (frameCount % Math.floor(spawnRate / timeModifier) === 0) spawnItem();

        // Player Movement & Logic
        player.x += (mouseX - player.x) * 0.25;
        
        let closestDist = 999;
        items.forEach(i => {
            const dy = player.y - i.y;
            if(dy > 0 && dy < 150 && Math.abs(player.x - i.x) < 60) closestDist = dy;
        });
        player.mouthOpen = closestDist < 100 ? 1 : 0;

        drawCat(player.x, player.y);

        // Handle Items
        for (let i = items.length - 1; i >= 0; i--) {
            let it = items[i];
            it.y += it.vy * timeModifier;
            it.rot += it.rotSpeed * timeModifier;
            drawItem(it);

            // Collision
            let dx = player.x - it.x;
            let dy = (player.y - 20) - it.y;
            let dist = Math.sqrt(dx*dx + dy*dy);

            if (dist < 45) {
                if (it.type === 'cucumber') {
                    player.face = 'dead'; drawCat(player.x, player.y);
                    createParticles(it.x, it.y, '#70e000', 15);
                    gameOver();
                    return;
                } else {
                    let pts = 0;
                    let color = '#fff';
                    playSound(it.type === 'coin' ? 'coin' : 'powerup');

                    if (it.type === 'coin') {
                        pts = isFeverMode ? 20 : 10;
                        color = '#ffca3a';
                        if (!isFeverMode) fever += 8;
                    } else if (it.type === 'gem') {
                        pts = isFeverMode ? 100 : 50;
                        color = '#4cc9f0';
                        if (!isFeverMode) fever += 20;
                    } else if (it.type === 'yarn') {
                        slowMoTimer = 180;
                        color = '#f72585';
                        floatText(it.x, it.y, "SLOW MO!", color);
                    }

                    if (pts > 0) {
                        score += pts;
                        floatText(it.x, it.y, `+${pts}`, color);
                    }
                    createParticles(it.x, it.y, color, 10);
                    updateUI();
                }
                items.splice(i, 1);
            } else if (it.y > height + 50) {
                if (it.type === 'coin' || it.type === 'gem') {
                    fever = 0; updateUI(); // Reset fever on miss
                }
                items.splice(i, 1);
            }
        }

        // Draw Particles
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            p.x += p.vx * timeModifier; p.y += p.vy * timeModifier;
            p.life -= 0.04;
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
            if(p.life <= 0) particles.splice(i,1);
        }
        ctx.globalAlpha = 1.0;

        // Fever drain
        if (isFeverMode && frameCount % Math.floor(5 / timeModifier) === 0) {
            fever -= 1;
            updateUI();
        }

        requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>
