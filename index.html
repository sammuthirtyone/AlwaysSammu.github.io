<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kitty Coin Catcher: Musical Edition</title>
    <meta name="description" content="Catch coins, avoid bombs! A musical adventure with cute cats!">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Fredoka', sans-serif; }
        body { background: #1a1a2e; height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .game-wrapper { position: relative; width: 100%; height: 100%; max-width: 600px; max-height: 900px; }
        .game-container { position: relative; width: 100%; height: 100%; background: linear-gradient(180deg, #e0c3fc 0%, #8ec5fc 100%); box-shadow: 0 0 40px rgba(0,0,0,0.5); overflow: hidden; display: flex; flex-direction: column; }
        @media (min-width: 601px) { .game-container { border-radius: 24px; height: 95vh; } }

        /* Loading Screen */
        .loading-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, #e0c3fc 0%, #8ec5fc 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.5s; }
        .loading-screen.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.3); border-top-color: #ff8fa3; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        .loading-text { font-size: 1.2rem; color: #5e548e; font-weight: 600; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* UI Elements */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; transition: opacity 0.3s; }
        .hud { padding: 20px; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
        .stat-pill { background: #fff; padding: 8px 16px; border-radius: 50px; border: 3px solid #fff; box-shadow: 0 6px 0 rgba(0,0,0,0.1); color: #5e548e; font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .btn-round { width: 50px; height: 50px; border-radius: 50%; border: none; background: #fff; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 0 #c8b6ff; color: #5e548e; display: flex; align-items: center; justify-content: center; transition: all 0.1s; pointer-events: auto; }
        .btn-round:active { transform: translateY(4px); box-shadow: none; }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; padding: 20px; transition: opacity 0.3s; }
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        h1 { font-size: 3.5rem; color: #ff8fa3; text-align: center; line-height: 1; text-shadow: 3px 3px 0 #fff; margin-bottom: 30px; }
        .btn-main { background: linear-gradient(to bottom, #ff8fa3, #ff5d8f); border: none; padding: 18px 60px; border-radius: 60px; font-size: 2rem; color: white; font-weight: 800; cursor: pointer; box-shadow: 0 8px 0 #c9184a; width: 80%; max-width: 350px; text-transform: uppercase; }
        .btn-main:active { transform: translateY(8px); box-shadow: 0 0 0 #c9184a; }
        
        .exit-fullscreen-btn { position: absolute; bottom: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.9); border: 2px solid #5e548e; color: #5e548e; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 30; }
        .exit-fullscreen-btn.visible { display: flex; }
        
        .sync-indicator { position: absolute; top: 20px; right: 80px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 20px; font-size: 0.7rem; color: #5e548e; border: 1px solid #5e548e; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .sync-indicator.visible { opacity: 1; }

        canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    </style>
    <script src="https://sdk.crazygames.com/crazygames-sdk-v3.js"></script>
</head>
<body>
<div class="game-wrapper">
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Connecting to SDK...</div>
    </div>

    <div class="game-container" id="gameContainer">
        <div class="sync-indicator" id="syncIndicator">üíæ Saved to Cloud</div>
        <button class="exit-fullscreen-btn" id="exitFullscreenBtn">‚§¨</button>

        <div class="ui-layer" id="uiLayer" style="opacity: 0;">
            <div class="hud">
                <div>
                    <div class="stat-pill" style="color: #ffb703;">ü™ô <span id="uiScore">0</span></div>
                    <div class="stat-pill" style="color: #ff5d8f;" id="uiLives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                </div>
                <button class="btn-round" id="btnPause">II</button>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div class="screen" id="screenStart">
            <h1>KITTY<br>CATCH</h1>
            <button class="btn-main" id="btnPlay">PLAY</button>
        </div>

        <div class="screen hidden" id="screenOver">
            <h1>GAME OVER</h1>
            <div style="font-size: 3rem; font-weight:800; color:#ff8fa3;"><span id="uiFinalScore">0</span></div>
            <button class="btn-main" id="btnRestart" style="margin-top:20px;">AGAIN!</button>
        </div>

        <div class="screen hidden" id="screenPause">
            <h1>PAUSED</h1>
            <button class="btn-main" id="btnResume">RESUME</button>
        </div>
    </div>
</div>

<script>
/**
 * SDK INITIALIZATION - MUST BE TOP-LEVEL FOR DETECTION
 */
let crazyGame = null;
let adInstance = null;
let dataModule = null;

(async () => {
    try {
        if (window.CrazyGames && window.CrazyGames.SDK) {
            crazyGame = await window.CrazyGames.SDK.init();
            adInstance = crazyGame.ad;
            dataModule = crazyGame.data;
            
            crazyGame.loadingStart(); // Signal start immediately
            console.log("SDK Detected");
            
            // Load cloud data
            const cloudData = await dataModule.getItem('kittyCatchData');
            if (cloudData) {
                const data = JSON.parse(cloudData);
                GameState.bestScore = data.bestScore || 0;
                GameState.coins = data.coins || 0;
            }
        }
    } catch (e) {
        console.error("SDK Init Error:", e);
    }
})();

// --- GAME STATE ---
const GameState = {
    score: 0,
    lives: 3,
    bestScore: 0,
    coins: 0,
    gameActive: false,
    isAdShowing: false
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
let canvasWidth, canvasHeight;
let lastTimestamp = 0;

const player = { x: 0, y: 0, targetX: 0, w: 70, h: 55 };
let entities = [];

// --- CORE FUNCTIONS ---
function resize() {
    const rect = document.getElementById('gameContainer').getBoundingClientRect();
    canvasWidth = rect.width;
    canvasHeight = rect.height;
    canvas.width = canvasWidth * window.devicePixelRatio;
    canvas.height = canvasHeight * window.devicePixelRatio;
    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    player.y = canvasHeight - 100;
}

async function saveToCloud() {
    if (dataModule) {
        await dataModule.setItem('kittyCatchData', JSON.stringify({
            bestScore: GameState.bestScore,
            coins: GameState.coins
        }));
        const indicator = document.getElementById('syncIndicator');
        indicator.classList.add('visible');
        setTimeout(() => indicator.classList.remove('visible'), 2000);
    }
}

function toggleScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById('uiLayer').style.opacity = (id === 'play') ? '1' : '0';
    
    if (id === 'play') {
        document.getElementById('screenStart').classList.add('hidden');
        GameState.gameActive = true;
        crazyGame?.gameplayStart(); // Required for "Gameplay requirements"
    } else {
        const screen = document.getElementById('screen' + id.charAt(0).toUpperCase() + id.slice(1));
        if (screen) screen.classList.remove('hidden');
        GameState.gameActive = false;
        crazyGame?.gameplayStop(); // Required for "Gameplay requirements"
    }
}

function startGame() {
    GameState.score = 0;
    GameState.lives = 3;
    entities = [];
    player.x = canvasWidth / 2 - player.w / 2;
    player.targetX = player.x;
    updateUI();
    toggleScreen('play');
}

function endGame() {
    if (GameState.score > GameState.bestScore) GameState.bestScore = GameState.score;
    GameState.coins += GameState.score;
    document.getElementById('uiFinalScore').textContent = GameState.score;
    
    crazyGame?.leaderboard.postScore(GameState.score);
    saveToCloud();
    toggleScreen('over');
}

function updateUI() {
    document.getElementById('uiScore').textContent = GameState.score;
    document.getElementById('uiLives').textContent = '‚ù§Ô∏è'.repeat(GameState.lives) + 'üñ§'.repeat(3 - GameState.lives);
}

// --- LOOP & RENDERING ---
function gameLoop(t) {
    const dt = (t - lastTimestamp) / 1000;
    lastTimestamp = t;

    if (GameState.gameActive && !GameState.isAdShowing) {
        player.x += (player.targetX - player.x) * 15 * dt;
        
        if (Math.random() < 0.02) {
            entities.push({ x: Math.random() * (canvasWidth - 30), y: -30, type: Math.random() > 0.8 ? 'bomb' : 'coin' });
        }

        for (let i = entities.length - 1; i >= 0; i--) {
            const e = entities[i];
            e.y += 200 * dt;
            
            if (e.y > player.y && e.y < player.y + player.h && e.x > player.x - 20 && e.x < player.x + player.w) {
                if (e.type === 'coin') { GameState.score += 10; crazyGame?.gameplay.happyTime(); }
                else { GameState.lives--; if (GameState.lives <= 0) endGame(); }
                entities.splice(i, 1);
                updateUI();
            } else if (e.y > canvasHeight) {
                entities.splice(i, 1);
            }
        }
    }

    ctx.fillStyle = '#c8b6ff';
    ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    
    ctx.fillStyle = '#ffcdb2';
    ctx.fillRect(player.x, player.y, player.w, player.h);

    entities.forEach(e => {
        ctx.fillStyle = e.type === 'coin' ? '#ffb703' : '#ef233c';
        ctx.beginPath(); ctx.arc(e.x, e.y, 15, 0, Math.PI * 2); ctx.fill();
    });

    requestAnimationFrame(gameLoop);
}

// --- INPUTS ---
canvas.addEventListener('touchmove', e => {
    const rect = canvas.getBoundingClientRect();
    player.targetX = (e.touches[0].clientX - rect.left) - player.w / 2;
});

// --- INIT ---
window.onload = () => {
    resize();
    window.addEventListener('resize', resize);
    
    setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('hidden');
        crazyGame?.loadingStop(); // Signal ready
    }, 1500);

    document.getElementById('btnPlay').onclick = startGame;
    document.getElementById('btnRestart').onclick = startGame;
    document.getElementById('btnPause').onclick = () => toggleScreen('pause');
    document.getElementById('btnResume').onclick = () => toggleScreen('play');

    requestAnimationFrame(gameLoop);
};
</script>
</body>
</html>
