<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Super Kitty Catch DX</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;800&display=swap');

        :root {
            --primary: #ff5d8f;
            --secondary: #6d597a;
            --accent: #ffb703;
            --bg-grad: linear-gradient(135deg, #ffd6e7 0%, #fff5e6 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Fredoka', sans-serif; }

        body {
            background: #222;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: none;
        }

        /* --- MAIN CARD --- */
        .game-card {
            width: 100%; max-width: 480px; height: 100%; max-height: 900px;
            background: var(--bg-grad);
            position: relative; display: flex; flex-direction: column; 
            overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        @media (min-width: 500px) {
            .game-card { border-radius: 30px; height: 95vh; border: 4px solid #fff; }
        }

        /* --- UI LAYERS --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between; padding: 15px;
        }

        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .score-pill {
            background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 30px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px;
            font-size: 1.2rem; font-weight: 800; color: var(--secondary);
            border: 2px solid #fff;
        }

        .life-bar { display: flex; gap: 5px; font-size: 1.5rem; filter: drop-shadow(0 2px 0 rgba(0,0,0,0.1)); }

        .fever-container {
            position: absolute; top: 60px; left: 15px; right: 15px; height: 8px;
            background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden;
            display: none; /* Hidden until gameplay */
        }
        .fever-fill {
            height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a00, #ff0000);
            transition: width 0.1s linear; box-shadow: 0 0 10px #ff9a00;
        }
        .fever-active .fever-fill { animation: rainbow 0.5s linear infinite; }
        @keyframes rainbow { 0%{filter:hue-rotate(0deg);} 100%{filter:hue-rotate(360deg);} }

        /* --- SCREENS --- */
        .screen {
            position: absolute; inset: 0; background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px); z-index: 20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.3s; padding: 20px; pointer-events: auto;
        }
        .hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }

        h1 { font-size: 3.5rem; line-height: 0.9; color: var(--primary); text-align: center; text-shadow: 3px 3px 0 #fff; margin-bottom: 20px; }
        h2 { color: var(--secondary); margin-bottom: 10px; }

        .btn {
            background: var(--primary); color: white; border: none; padding: 15px 40px;
            border-radius: 50px; font-size: 1.5rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 6px 0 #c9184a, 0 15px 20px rgba(255, 93, 143, 0.4);
            transition: transform 0.1s, box-shadow 0.1s; margin: 8px; width: 100%; max-width: 300px;
            position: relative; overflow: hidden;
        }
        .btn:active { transform: translateY(6px); box-shadow: 0 0 0 #c9184a; }
        .btn-secondary { background: #4cc9f0; box-shadow: 0 6px 0 #3a86ff; }
        .btn-secondary:active { box-shadow: 0 0 0 #3a86ff; }
        
        .btn-small { padding: 10px 20px; font-size: 1rem; width: auto; display: inline-block; margin-top: 10px;}

        /* --- CANVAS --- */
        canvas { display: block; width: 100%; height: 100%; cursor: none; }
        
        /* --- SHOP UI --- */
        .shop-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
            width: 100%; overflow-y: auto; padding: 10px; max-height: 60vh;
            padding-bottom: 50px;
        }
        
        .shop-item {
            background: #fff; border-radius: 20px; padding: 15px; text-align: center;
            border: 3px solid #eee; position: relative; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
        }
        .shop-item.owned { border-color: #bde0fe; background: #f0f9ff; }
        .shop-item.equipped { border-color: var(--primary); background: #fff0f6; box-shadow: 0 0 15px rgba(255,93,143,0.3); }
        .shop-item.locked { opacity: 0.6; filter: grayscale(1); }

        .item-preview { width: 60px; height: 60px; margin-bottom: 5px; }
        .price-tag { 
            background: #eee; padding: 4px 10px; border-radius: 8px; font-size: 0.9rem; font-weight: bold; color: #555;
        }
        .can-afford { background: #d1fae5; color: #065f46; }

        .tabs { display: flex; width: 100%; gap: 10px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; background: #eee; border:none; border-radius: 12px; font-weight:bold; color:#888; }
        .tab.active { background: var(--secondary); color: white; }

        /* --- ANIMATIONS --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .shaking { animation: shake 0.5s; }

        .flash { animation: flashRed 0.2s; }
        @keyframes flashRed { 0% { background: rgba(255,0,0,0.5); } 100% { background: transparent; } }

    </style>
</head>
<body>

<div class="game-card" id="gameCard">
    
    <div class="ui-layer">
        <div class="hud-top">
            <div class="score-pill">ü™ô <span id="scoreDisplay">0</span></div>
            <div class="life-bar" id="livesDisplay">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
        <div class="fever-container" id="feverBarContainer">
            <div class="fever-fill" id="feverFill"></div>
        </div>
        <div style="text-align: center; color: rgba(0,0,0,0.3); margin-top: auto; font-size: 0.9rem;">
            Slide to move ‚Ä¢ Catch Coins ‚Ä¢ Dodge Bombs
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div class="screen" id="startScreen">
        <div style="font-size: 6rem; margin-bottom: 20px;">üê±</div>
        <h1>KITTY<br>RUSH</h1>
        <div class="score-pill" style="margin-bottom: 20px;">Best: <span id="highScoreDisplay">0</span></div>
        <button class="btn" onclick="startGame()">PLAY</button>
        <button class="btn btn-secondary" onclick="openShop()">SHOP üõí</button>
    </div>

    <div class="screen hidden" id="shopScreen">
        <div class="hud-top" style="width:100%; margin-bottom: 15px;">
            <button class="btn-small" onclick="closeShop()" style="background:#ccc; box-shadow:0 4px 0 #999;">‚Üê Back</button>
            <div class="score-pill">ü™ô <span id="walletDisplay">0</span></div>
        </div>
        <h2>MARKETPLACE</h2>
        
        <div class="tabs">
            <button class="tab active" onclick="setTab('skins')" id="tabSkins">SKINS</button>
            <button class="tab" onclick="setTab('upgrades')" id="tabUpgrades">UPGRADES</button>
        </div>

        <div class="shop-grid" id="shopGrid">
            </div>
    </div>

    <div class="screen hidden" id="gameOverScreen">
        <h1 style="font-size: 3rem; color: #ff0000;">CRASH!</h1>
        <h2 style="font-size: 1.5rem;">Score</h2>
        <div style="font-size: 4rem; font-weight: 800; color: var(--accent); text-shadow: 2px 2px 0 #000; margin-bottom: 20px;" id="finalScore">0</div>
        
        <div class="score-pill" style="margin-bottom: 20px;">Total Coins: <span id="totalCoinsOver">0</span></div>

        <button class="btn" onclick="startGame()">RETRY üîÑ</button>
        <button class="btn btn-secondary" onclick="openShop()">SPEND COINS üõí</button>
        <button class="btn-small" onclick="location.reload()" style="background:transparent; color:#888; box-shadow:none; margin-top:20px;">Main Menu</button>
    </div>

</div>

<script>
/**
 * SUPER KITTY RUSH
 * A high-octane canvas game by Gemini
 */

// --- CONFIG & DB ---
const DB = {
    skins: [
        { id: 'cat_orange', name: 'Tabby', type: 'Common', price: 0, color: '#ffaa5e' },
        { id: 'cat_black', name: 'Void', type: 'Common', price: 250, color: '#333' },
        { id: 'cat_white', name: 'Snow', type: 'Common', price: 500, color: '#fff' },
        { id: 'cat_pink', name: 'Berry', type: 'Rare', price: 1000, color: '#ff70a6' },
        { id: 'cat_blue', name: 'Slime', type: 'Rare', price: 1500, color: '#4cc9f0' },
        { id: 'cat_gold', name: 'Midas', type: 'Legendary', price: 5000, color: '#ffd700' },
        { id: 'cat_robo', name: 'Mecha', type: 'Legendary', price: 3000, color: '#adb5bd' },
        { id: 'cat_ninja', name: 'Shinobi', type: 'Rare', price: 2000, color: '#343a40' },
        { id: 'cat_alien', name: 'Gnarp', type: 'Rare', price: 2500, color: '#70e000' },
        { id: 'cat_ghost', name: 'Spooky', type: 'Legendary', price: 4000, color: 'rgba(255,255,255,0.6)' },
        { id: 'cat_burger', name: 'Borgir', type: 'Legendary', price: 6000, color: '#f4a261' },
        { id: 'cat_king', name: 'Royal', type: 'Ultra', price: 10000, color: '#9d4edd' }
    ],
    upgrades: [
        { id: 'magnet', name: 'Magnet Time', base: 500, inc: 1.5, max: 5 },
        { id: 'shield', name: 'Shield Time', base: 600, inc: 1.5, max: 5 },
        { id: 'luck', name: 'Luck (More Powerups)', base: 1000, inc: 2.0, max: 3 }
    ]
};

// --- STATE MANAGEMENT ---
const STATE = {
    coins: 0,
    highScore: 0,
    inventory: ['cat_orange'],
    equipped: 'cat_orange',
    levels: { magnet: 0, shield: 0, luck: 0 }
};

// Load Data
const saveStr = localStorage.getItem('kittyRush_v2');
if(saveStr) Object.assign(STATE, JSON.parse(saveStr));

function saveGame() {
    localStorage.setItem('kittyRush_v2', JSON.stringify(STATE));
    updateUI();
}

// --- ENGINE VARIABLES ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
let W, H;
let frame = 0;
let isPlaying = false;
let score = 0;
let lives = 3;
let speedMult = 1;
let fever = 0;
let feverActive = false;
let activeTab = 'skins';

// Physics
const player = { x: 0, y: 0, w: 80, h: 80, targetX: 0, skin: 'cat_orange' };
let entities = [];
let particles = [];
let texts = [];

// Powerups
let magnetActive = 0;
let shieldActive = 0;

// --- INITIALIZATION ---
function resize() {
    const rect = canvas.parentElement.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    W = rect.width;
    H = rect.height;
    player.y = H - 110;
    if(!isPlaying) {
        player.x = W/2 - player.w/2;
        player.targetX = player.x;
    }
}
window.addEventListener('resize', resize);
setTimeout(resize, 100);

// --- GAME LOOP ---
function startGame() {
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('gameOverScreen').classList.add('hidden');
    document.getElementById('feverBarContainer').style.display = 'block';
    
    // Reset Game State
    isPlaying = true;
    score = 0;
    lives = 3;
    frame = 0;
    speedMult = 1;
    fever = 0;
    feverActive = false;
    entities = [];
    particles = [];
    texts = [];
    magnetActive = 0;
    shieldActive = 0;
    
    player.skin = STATE.equipped;
    player.targetX = W/2 - player.w/2;
    player.x = player.targetX;
    
    updateUI();
    loop();
}

function loop() {
    if(!isPlaying) return;
    
    // Logic
    frame++;
    updatePlayer();
    updateSpawner();
    updateEntities();
    updateParticles();
    
    // Difficulty Ramp
    if(frame % 600 === 0) speedMult += 0.1; // Faster every 10s
    
    // Fever Decay
    if(feverActive) {
        fever -= 0.5;
        if(fever <= 0) { feverActive = false; fever = 0; }
    } else {
        fever = Math.max(0, fever - 0.05);
    }
    document.getElementById('feverFill').style.width = fever + '%';
    if(feverActive) document.getElementById('feverBarContainer').classList.add('fever-active');
    else document.getElementById('feverBarContainer').classList.remove('fever-active');

    // Render
    draw();
    
    requestAnimationFrame(loop);
}

// --- LOGIC ---
function updatePlayer() {
    // Smooth movement
    player.x += (player.targetX - player.x) * 0.2;
    
    // Clamp
    if(player.x < 0) player.x = 0;
    if(player.x > W - player.w) player.x = W - player.w;

    if(magnetActive > 0) magnetActive--;
    if(shieldActive > 0) shieldActive--;
}

function updateSpawner() {
    // Spawn rate increases with speed
    const spawnRate = Math.max(15, Math.floor(40 / speedMult));
    
    if(frame % spawnRate === 0) {
        const typeRoll = Math.random();
        let type = 'coin';
        
        // Luck Logic
        const luckBonus = STATE.levels.luck * 0.02;
        
        if(lives < 3 && typeRoll > 0.98) type = 'heart';
        else if(typeRoll > 0.95 - luckBonus) type = Math.random()>0.5 ? 'magnet' : 'shield';
        else if(typeRoll < 0.2 + (speedMult * 0.05)) type = 'bomb'; // More bombs later
        
        // Pattern: Wall (Hard Mode)
        if(speedMult > 1.3 && Math.random() < 0.05) {
            spawnWall();
            return;
        }

        const size = type === 'coin' ? 30 : 40;
        entities.push({
            x: Math.random() * (W - size),
            y: -50,
            w: size, h: size,
            type: type,
            vy: (3 + Math.random() * 2) * speedMult,
            rot: 0, vrot: (Math.random()-0.5) * 0.2
        });
    }
}

function spawnWall() {
    const gap = Math.floor(Math.random() * 4); // 4 columns
    const colW = W / 4;
    for(let i=0; i<4; i++) {
        if(i === gap) continue;
        entities.push({
            x: i * colW + colW/2 - 20,
            y: -50,
            w: 40, h: 40,
            type: 'bomb',
            vy: 4 * speedMult,
            rot: 0, vrot: 0.1
        });
    }
}

function updateEntities() {
    for(let i = entities.length - 1; i >= 0; i--) {
        const e = entities[i];
        
        // Physics
        if(e.type === 'coin' && magnetActive > 0) {
            e.x += (player.x + player.w/2 - e.x) * 0.15;
            e.y += (player.y + player.h/2 - e.y) * 0.15;
        } else {
            e.y += e.vy;
        }
        e.rot += e.vrot;

        // Collision
        if(rectIntersect(player.x + 10, player.y + 10, player.w - 20, player.h - 20, e.x, e.y, e.w, e.h)) {
            handleCollect(e);
            entities.splice(i, 1);
            continue;
        }

        // Cleanup
        if(e.y > H) entities.splice(i, 1);
    }
}

function handleCollect(e) {
    const cx = e.x + e.w/2;
    const cy = e.y + e.h/2;

    if(e.type === 'bomb') {
        if(shieldActive > 0 || feverActive) {
            spawnText("BLOCKED!", cx, cy, '#fff');
            playSound(400, 'sawtooth', 0.1);
        } else {
            lives--;
            document.getElementById('gameCard').classList.add('shaking');
            document.getElementById('gameCard').classList.add('flash');
            setTimeout(()=> document.getElementById('gameCard').classList.remove('shaking'), 500);
            setTimeout(()=> document.getElementById('gameCard').classList.remove('flash'), 200);
            spawnParticles(cx, cy, '#000', 10);
            spawnText("-1 HP", cx, cy, '#ff0000');
            playSound(100, 'sawtooth', 0.5);
            fever = 0; // Lost momentum
            
            if(lives <= 0) gameOver();
        }
    } else if (e.type === 'coin') {
        let val = 10;
        if(feverActive) val *= 2;
        score += val;
        
        // Build Fever
        if(!feverActive) {
            fever += 5;
            if(fever >= 100) {
                fever = 100;
                feverActive = true;
                spawnText("FEVER TIME!!", W/2, H/2, '#fff', 30);
                playSound(600, 'square', 0.5);
            }
        }
        
        spawnText("+" + val, cx, cy, '#ffb703');
        spawnParticles(cx, cy, '#ffb703', 5);
        playSound(800 + (fever*5), 'sine', 0.1);
    } else {
        // Powerups
        if(e.type === 'heart') { lives = Math.min(3, lives+1); spawnText("HP UP", cx, cy, '#ff5d8f'); }
        if(e.type === 'magnet') { 
            magnetActive = 300 + (STATE.levels.magnet * 60); 
            spawnText("MAGNET", cx, cy, '#4cc9f0'); 
        }
        if(e.type === 'shield') { 
            shieldActive = 300 + (STATE.levels.shield * 60); 
            spawnText("SHIELD", cx, cy, '#ffd166'); 
        }
        playSound(600, 'square', 0.2);
    }
    updateUI();
}

function updateParticles() {
    for(let i=particles.length-1; i>=0; i--) {
        const p = particles[i];
        p.x += p.vx; p.y += p.vy;
        p.vy += 0.5; // Gravity
        p.life -= 0.05;
        if(p.life <= 0) particles.splice(i, 1);
    }
    for(let i=texts.length-1; i>=0; i--) {
        const t = texts[i];
        t.y -= 2; t.life -= 0.02;
        if(t.life <= 0) texts.splice(i, 1);
    }
}

// --- RENDERER ---
function draw() {
    // Clear
    ctx.fillStyle = '#ffecf2';
    // Draw Background Gradient
    const grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0, '#ffd6e7');
    grad.addColorStop(1, '#fff5e6');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,W,H);

    // Fever Overlay
    if(feverActive) {
        ctx.fillStyle = `rgba(255, 200, 0, 0.1)`;
        ctx.fillRect(0,0,W,H);
    }

    // Draw Entities
    entities.forEach(e => {
        ctx.save();
        ctx.translate(e.x + e.w/2, e.y + e.h/2);
        ctx.rotate(e.rot);
        
        if(e.type === 'coin') {
            ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2);
            ctx.fillStyle = '#ffb703'; ctx.fill();
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = '#fff'; ctx.font = 'bold 16px Arial'; ctx.textAlign = 'center'; ctx.textBaseline='middle';
            ctx.fillText('$', 0, 1);
        } else if (e.type === 'bomb') {
            ctx.beginPath(); ctx.arc(0,2,16,0,Math.PI*2);
            ctx.fillStyle = '#222'; ctx.fill();
            ctx.fillStyle = '#fff'; ctx.font = '20px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText('üíÄ', 0, 0);
            // Fuse
            ctx.beginPath(); ctx.moveTo(0,-14); ctx.quadraticCurveTo(5,-20, 10, -18); 
            ctx.strokeStyle='#444'; ctx.lineWidth=2; ctx.stroke();
        } else {
            // Powerups
            const icon = e.type === 'heart' ? 'üíñ' : e.type === 'magnet' ? 'üß≤' : 'üõ°Ô∏è';
            ctx.font = '30px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(icon, 0, 0);
        }
        ctx.restore();
    });

    // Draw Player
    drawPlayerSkin(player.x, player.y, player.w, player.h, player.skin);

    // Draw Particles
    particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.fillRect(p.x, p.y, p.size, p.size);
        ctx.globalAlpha = 1;
    });

    // Draw Texts
    texts.forEach(t => {
        ctx.globalAlpha = t.life;
        ctx.font = `800 ${t.size}px Fredoka`;
        ctx.fillStyle = t.color;
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 4;
        ctx.textAlign = 'center';
        ctx.strokeText(t.str, t.x, t.y);
        ctx.fillText(t.str, t.x, t.y);
        ctx.globalAlpha = 1;
    });
}

// --- SKIN RENDERER (The Magic) ---
function drawPlayerSkin(x, y, w, h, skinId) {
    const cx = x + w/2;
    const cy = y + h/2;
    const skin = DB.skins.find(s=>s.id === skinId) || DB.skins[0];
    const color = skin.color;
    
    // Effects (Shield/Magnet)
    if(magnetActive > 0) {
        ctx.beginPath(); ctx.arc(cx, cy, w*0.8, 0, Math.PI*2);
        ctx.strokeStyle = `rgba(76, 201, 240, ${(Math.sin(frame*0.2)+1)/2})`; ctx.lineWidth=3; ctx.stroke();
    }
    if(shieldActive > 0 || feverActive) {
        ctx.beginPath(); ctx.arc(cx, cy, w*0.7, 0, Math.PI*2);
        ctx.strokeStyle = '#ffd166'; ctx.lineWidth=3; ctx.stroke();
    }

    ctx.save();
    ctx.translate(cx, cy);
    
    // Lean effect
    const lean = (player.targetX - player.x) * 0.05;
    ctx.rotate(lean * Math.PI/180);

    // BASE SHAPES
    if(skinId === 'cat_ghost') ctx.globalAlpha = 0.6;

    // Body
    ctx.fillStyle = color;
    if(skinId === 'cat_robo' || skinId === 'cat_burger') {
        ctx.beginPath(); ctx.roundRect(-w/2, -h/2 + 10, w, h-10, 10); ctx.fill();
    } else if (skinId === 'cat_alien') {
        ctx.beginPath(); ctx.ellipse(0, 5, w/2, h/2 - 5, 0, 0, Math.PI*2); ctx.fill();
    } else {
        // Standard Cat Shape
        ctx.beginPath(); 
        ctx.moveTo(-w/2 + 10, h/2); 
        ctx.lineTo(-w/2, 0); 
        ctx.quadraticCurveTo(-w/2, -h/2 + 15, 0, -h/2 + 15);
        ctx.quadraticCurveTo(w/2, -h/2 + 15, w/2, 0);
        ctx.lineTo(w/2 - 10, h/2);
        ctx.fill();
    }

    // Ears
    if(skinId !== 'cat_burger' && skinId !== 'cat_alien') {
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.moveTo(-20, -h/2 + 20); ctx.lineTo(-35, -h/2 - 10); ctx.lineTo(-5, -h/2 + 15); ctx.fill(); // L
        ctx.beginPath(); ctx.moveTo(20, -h/2 + 20); ctx.lineTo(35, -h/2 - 10); ctx.lineTo(5, -h/2 + 15); ctx.fill(); // R
    } else if (skinId === 'cat_alien') {
        // Antenna
        ctx.strokeStyle = color; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.moveTo(0, -h/2 + 10); ctx.lineTo(0, -h/2 - 15); ctx.stroke();
        ctx.fillStyle = '#ccff33'; ctx.beginPath(); ctx.arc(0, -h/2 - 15, 6, 0, Math.PI*2); ctx.fill();
    }

    // Face
    ctx.fillStyle = (skinId === 'cat_black' || skinId === 'cat_ninja') ? '#fff' : '#333';
    
    if(skinId === 'cat_robo') {
        // Robo Visor
        ctx.fillStyle = '#000'; ctx.fillRect(-25, -10, 50, 15);
        ctx.fillStyle = '#ff0000'; ctx.fillRect(-10 + Math.sin(frame*0.2)*10, -5, 20, 5);
    } else if (skinId === 'cat_ninja') {
        // Mask
        ctx.fillStyle = '#222'; ctx.fillRect(-w/2, 0, w, 40);
        // Eyes
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(-15, -5, 5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(15, -5, 5, 0, Math.PI*2); ctx.fill();
    } else if (skinId === 'cat_king') {
        // Crown
        ctx.fillStyle = '#ffcc00';
        ctx.beginPath(); ctx.moveTo(-25, -30); ctx.lineTo(-15, -50); ctx.lineTo(0, -30); ctx.lineTo(15, -50); ctx.lineTo(25, -30); ctx.lineTo(25, -20); ctx.lineTo(-25, -20); ctx.fill();
        // Standard Face
        ctx.fillStyle = '#333';
        ctx.beginPath(); ctx.arc(-15, 0, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(15, 0, 4, 0, Math.PI*2); ctx.fill();
    } else {
        // Standard Eyes
        ctx.beginPath(); ctx.arc(-15, 0, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(15, 0, 4, 0, Math.PI*2); ctx.fill();
        ctx.font = '10px Arial'; ctx.textAlign='center'; ctx.fillText('w', 0, 10);
    }

    // Accessories
    if(skinId === 'cat_burger') {
        ctx.fillStyle = '#6f4e37'; ctx.fillRect(-w/2, -5, w, 8); // Patty
        ctx.fillStyle = '#90be6d'; ctx.fillRect(-w/2, 3, w, 5); // Lettuce
        ctx.fillStyle = '#f4a261'; ctx.beginPath(); ctx.arc(0, -h/2+10, w/2, Math.PI, 0); ctx.fill(); // Bun Top
    }

    ctx.restore();
    ctx.globalAlpha = 1;
}


// --- UTILS ---
function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
    return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
}

function spawnParticles(x, y, color, count) {
    for(let i=0; i<count; i++) {
        particles.push({
            x: x, y: y,
            vx: (Math.random()-0.5)*10,
            vy: (Math.random()-0.5)*10,
            life: 1, size: Math.random()*6+2, color: color
        });
    }
}

function spawnText(str, x, y, color, size=20) {
    texts.push({ str, x, y, color, size, life: 1.0 });
}

function gameOver() {
    isPlaying = false;
    STATE.coins += score;
    if(score > STATE.highScore) STATE.highScore = score;
    saveGame();
    
    document.getElementById('finalScore').innerText = score;
    document.getElementById('totalCoinsOver').innerText = STATE.coins;
    document.getElementById('gameOverScreen').classList.remove('hidden');
    document.getElementById('feverBarContainer').style.display = 'none';
}

function updateUI() {
    document.getElementById('scoreDisplay').innerText = score;
    document.getElementById('walletDisplay').innerText = STATE.coins;
    document.getElementById('highScoreDisplay').innerText = STATE.highScore;
    
    let hStr = '';
    for(let i=0; i<3; i++) hStr += i<lives ? '‚ù§Ô∏è' : 'üñ§';
    document.getElementById('livesDisplay').innerText = hStr;
}

// --- INPUT ---
function handleInput(e) {
    if(!isPlaying) return;
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const scaleX = canvas.width / rect.width / (window.devicePixelRatio || 1); 
    
    let pos = (clientX - rect.left);
    player.targetX = pos - player.w/2;
}
canvas.addEventListener('mousemove', handleInput);
canvas.addEventListener('touchmove', (e)=>{ e.preventDefault(); handleInput(e); }, {passive:false});
canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); handleInput(e); }, {passive:false});

// --- AUDIO (Synthesized) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type, dur) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
}

// --- SHOP LOGIC ---
function openShop() {
    document.getElementById('shopScreen').classList.remove('hidden');
    setTab(activeTab);
}
function closeShop() {
    document.getElementById('shopScreen').classList.add('hidden');
    player.skin = STATE.equipped; // Update preview if game runs
}

function setTab(tab) {
    activeTab = tab;
    document.getElementById('tabSkins').className = tab === 'skins' ? 'tab active' : 'tab';
    document.getElementById('tabUpgrades').className = tab === 'upgrades' ? 'tab active' : 'tab';
    renderShop();
}

function renderShop() {
    const grid = document.getElementById('shopGrid');
    grid.innerHTML = '';
    
    if(activeTab === 'skins') {
        DB.skins.forEach(item => {
            const owned = STATE.inventory.includes(item.id);
            const equipped = STATE.equipped === item.id;
            const canAfford = STATE.coins >= item.price;
            
            const div = document.createElement('div');
            div.className = `shop-item ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''} ${!owned && !canAfford ? 'locked' : ''}`;
            
            // Draw Mini Preview
            const cvs = document.createElement('canvas');
            cvs.width=60; cvs.height=60; 
            const c = cvs.getContext('2d');
            
            // Hacky mini-render context
            const oldCtx = ctx; 
            // We can't easily swap context for the main draw function, so we make a simple icon
            c.fillStyle = item.color; c.beginPath(); c.arc(30,30,25,0,Math.PI*2); c.fill();
            c.fillStyle = '#000'; c.fillText(item.name[0], 25, 35);

            div.innerHTML = `
                <div style="font-size:2rem;margin-bottom:5px;">üê±</div>
                <div style="font-weight:bold; font-size:0.9rem; color:#555">${item.name}</div>
                <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">${item.type}</div>
            `;
            
            const btn = document.createElement('div');
            if(equipped) {
                btn.className = 'price-tag'; btn.style.background = '#ff5d8f'; btn.style.color='white'; btn.innerText = 'EQUIPPED';
            } else if (owned) {
                btn.className = 'price-tag'; btn.innerText = 'EQUIP';
                div.onclick = () => { STATE.equipped = item.id; saveGame(); renderShop(); playSound(400,'sine',0.1); };
            } else {
                btn.className = `price-tag ${canAfford ? 'can-afford' : ''}`;
                btn.innerText = 'ü™ô ' + item.price;
                if(canAfford) div.onclick = () => {
                    STATE.coins -= item.price;
                    STATE.inventory.push(item.id);
                    STATE.equipped = item.id;
                    saveGame(); renderShop(); playSound(600,'triangle',0.2);
                };
            }
            div.appendChild(btn);
            grid.appendChild(div);
        });
    } else {
        DB.upgrades.forEach(upg => {
            const lvl = STATE.levels[upg.id];
            const price = Math.floor(upg.base * Math.pow(upg.inc, lvl));
            const isMax = lvl >= upg.max;
            const canAfford = !isMax && STATE.coins >= price;
            
            const div = document.createElement('div');
            div.className = `shop-item ${isMax ? 'locked' : ''}`;
            div.innerHTML = `
                <div style="font-size:2rem;">‚¨ÜÔ∏è</div>
                <div style="font-weight:bold; color:#555">${upg.name}</div>
                <div style="color:var(--primary); font-weight:800;">Lvl ${lvl} / ${upg.max}</div>
            `;
            
            const btn = document.createElement('div');
            if(isMax) {
                btn.className = 'price-tag'; btn.innerText = 'MAXED';
            } else {
                btn.className = `price-tag ${canAfford ? 'can-afford' : ''}`;
                btn.innerText = 'ü™ô ' + price;
                if(canAfford) div.onclick = () => {
                    STATE.coins -= price;
                    STATE.levels[upg.id]++;
                    saveGame(); renderShop(); playSound(600,'triangle',0.2);
                };
            }
            div.appendChild(btn);
            grid.appendChild(div);
        });
    }
}

// Initial Save Check
if(!localStorage.getItem('kittyRush_v2')) saveGame();

</script>
</body>
</html>
