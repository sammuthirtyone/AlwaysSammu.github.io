<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üê± Kitty Coin Catcher: Ultimate</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        :root {
            --primary: #ff8fab;
            --secondary: #ffc2d1;
            --accent: #fb6f92;
            --dark: #594a4e;
            --gold: #ffca3a;
            --bg: #ffe5ec;
            --green: #70e000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Fredoka', sans-serif; }

        body {
            background: var(--bg);
            background-image: radial-gradient(var(--secondary) 15%, transparent 16%);
            background-size: 30px 30px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }

        #game-frame {
            position: relative;
            width: 100%; max-width: 500px;
            height: 100%; max-height: 900px;
            background: #fff;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(251, 111, 146, 0.3);
        }
        @media(min-width: 500px) {
            #game-frame { height: 95vh; border-radius: 30px; border: 8px solid #fff; }
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* --- UI LAYERS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 20; transition: all 0.3s ease;
            pointer-events: auto;
        }
        .hidden { opacity: 0; pointer-events: none; transform: scale(1.05); }
        .backdrop { background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); }
        
        /* --- HUD --- */
        .hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }
        .top-bar {
            display: flex; justify-content: space-between; padding: 15px;
            align-items: flex-start;
        }
        .score-box {
            background: #fff; padding: 5px 15px; border-radius: 20px;
            box-shadow: 0 4px 0 #eee; font-weight: 700; color: var(--dark);
            font-size: 1.2rem; display: flex; flex-direction: column; align-items: center;
        }
        .score-box span { font-size: 0.8rem; color: #aaa; text-transform: uppercase; }
        
        .combo-meter {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            font-size: 2rem; font-weight: 900; color: var(--accent);
            text-shadow: 2px 2px 0 #fff; opacity: 0; transition: opacity 0.2s;
        }
        
        /* Fever Bar */
        .fever-wrapper {
            position: absolute; bottom: 20px; left: 10%; width: 80%;
            height: 20px; background: rgba(0,0,0,0.1); border-radius: 10px;
            border: 3px solid #fff; overflow: hidden;
        }
        .fever-fill {
            height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e, #ff0055);
            transition: width 0.1s linear;
        }
        .fever-active .fever-fill {
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
            animation: rainbow 0.5s linear infinite;
        }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        /* --- BUTTONS --- */
        .btn-main {
            background: linear-gradient(to bottom, #ff8fab, #fb6f92);
            border: none; padding: 15px 40px; border-radius: 50px;
            color: white; font-size: 1.8rem; font-weight: 700;
            box-shadow: 0 6px 0 #c9184a, 0 15px 20px rgba(251, 111, 146, 0.4);
            cursor: pointer; transition: transform 0.1s; margin: 10px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }
        .btn-main:active { transform: translateY(6px); box-shadow: 0 0 0 #c9184a; }
        
        .btn-icon {
            background: #fff; width: 50px; height: 50px; border-radius: 15px;
            border: 2px solid #eee; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 4px 0 #ddd; display: grid; place-items: center;
        }
        .btn-icon:active { transform: translateY(4px); box-shadow: none; }

        /* --- SHOP --- */
        .shop-container {
            width: 90%; max-height: 60vh; overflow-y: auto;
            background: #fff; border-radius: 20px; padding: 15px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05); margin: 20px 0;
        }
        .shop-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab { 
            flex: 1; padding: 10px; background: #eee; border-radius: 10px; 
            text-align: center; font-weight: 700; color: #888; cursor: pointer;
        }
        .tab.active { background: var(--primary); color: #fff; }

        .shop-item {
            display: flex; align-items: center; background: #fafafa;
            margin-bottom: 10px; padding: 10px; border-radius: 15px;
            border: 2px solid #eee;
        }
        .shop-icon { font-size: 2rem; width: 50px; text-align: center; margin-right: 10px; }
        .shop-info { flex: 1; }
        .shop-name { font-weight: 700; color: var(--dark); }
        .shop-desc { font-size: 0.8rem; color: #888; }
        .shop-btn {
            background: var(--gold); border: none; padding: 8px 15px;
            border-radius: 10px; font-weight: 700; color: #d35400;
            cursor: pointer; box-shadow: 0 3px 0 #e67e22;
        }
        .shop-btn:disabled { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }
        .shop-btn.owned { background: #70e000; color: #fff; box-shadow: 0 3px 0 #38b000; }

        /* --- MENUS --- */
        #startScreen h1 {
            font-size: 3.5rem; color: var(--accent); line-height: 1;
            text-shadow: 4px 4px 0 #fff; margin: 20px 0; text-align: center;
        }
        .currency-display {
            background: var(--gold); color: #8a5a00; padding: 8px 20px;
            border-radius: 50px; font-weight: 700; font-size: 1.2rem;
            display: flex; gap: 8px; align-items: center; border: 2px solid #fff;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }

        /* --- ANIMATIONS --- */
        .float-text {
            position: absolute; font-weight: 900; pointer-events: none;
            animation: floatUp 0.8s ease-out forwards; z-index: 100;
            -webkit-text-stroke: 1px white;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-10px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-50px) scale(1); opacity: 0; }
        }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

    </style>
</head>
<body>

<div id="game-frame">
    <canvas id="gameCanvas"></canvas>

    <div class="hud-layer" id="gameHUD" style="display:none;">
        <div class="top-bar">
            <button class="btn-icon" style="pointer-events:auto;" onclick="togglePause()">‚è∏Ô∏è</button>
            <div class="score-box">
                <span id="scoreLabel">SCORE</span>
                <div id="scoreDisplay">0</div>
            </div>
            <div class="score-box" style="color: var(--gold);">
                <span>BANK</span>
                <div id="bankDisplayHUD">0</div>
            </div>
        </div>
        <div class="combo-meter" id="comboDisplay">x1 COMBO!</div>
        <div class="fever-wrapper">
            <div class="fever-fill" id="feverBar"></div>
        </div>
        <div style="position:absolute; bottom:45px; width:100%; text-align:center; font-weight:bold; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,0.3);" id="powerupText"></div>
    </div>

    <div class="screen backdrop" id="startScreen">
        <div style="flex:1;"></div>
        <div style="font-size: 5rem; animation: bounce 2s infinite;">üò∫</div>
        <h1>KITTY<br>COIN<br>DELUXE</h1>
        
        <div class="currency-display" style="margin-bottom: 20px;">
            ü™ô <span id="menuBank">0</span>
        </div>

        <button class="btn-main" onclick="startGame()">PLAY ‚ñ∂</button>
        
        <div style="display:flex; gap: 15px; margin-top: 10px;">
            <button class="btn-icon" onclick="openShop()">üõí</button>
            <button class="btn-icon" id="muteBtn" onclick="toggleMute()">üîä</button>
        </div>
        <div style="flex:1;"></div>
        <p style="color:#aaa; font-size:0.9rem; margin-bottom: 20px;">Best Score: <span id="menuHighScore">0</span></p>
    </div>

    <div class="screen backdrop hidden" id="shopScreen" style="justify-content: flex-start; padding-top: 40px;">
        <h2 style="color: var(--dark);">ITEM SHOP</h2>
        <div class="currency-display">ü™ô <span id="shopBank">0</span></div>
        
        <div class="shop-container">
            <div class="shop-tabs">
                <div class="tab active" onclick="switchTab('upgrades')">Upgrades</div>
                <div class="tab" onclick="switchTab('skins')">Skins</div>
            </div>
            <div id="shopList"></div>
        </div>

        <button class="btn-main" style="padding: 10px 30px; font-size: 1.2rem;" onclick="closeShop()">CLOSE ‚úñ</button>
    </div>

    <div class="screen backdrop hidden" id="pauseScreen">
        <h2 style="font-size: 3rem; color: var(--dark); margin-top: 30%;">PAUSED</h2>
        <button class="btn-main" onclick="togglePause()">RESUME</button>
        <button class="btn-icon" onclick="quitGame()" style="margin-top: 15px;">üè†</button>
    </div>

    <div class="screen backdrop hidden" id="gameOverScreen">
        <h2 style="font-size: 3rem; color: var(--accent); margin-top: 20%;">GAME OVER</h2>
        <div style="background: #fff; padding: 20px; border-radius: 20px; text-align: center; margin: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
            <p style="color:#aaa; font-size: 0.9rem;">SCORE</p>
            <div style="font-size: 2.5rem; font-weight: 900; color: var(--dark);" id="endScore">0</div>
            <hr style="border:0; border-top: 2px dashed #eee; margin: 10px 0;">
            <p style="color:#aaa; font-size: 0.9rem;">COINS EARNED</p>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--gold);" id="endCoins">+0</div>
        </div>
        <button class="btn-main" onclick="startGame()">RETRY üîÑ</button>
        <button class="btn-icon" onclick="quitGame()" style="margin-top: 10px;">üè†</button>
    </div>
</div>

<script>
    /* --- DATA & STATE --- */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    const frame = document.getElementById('game-frame');

    const STATE = {
        score: 0,
        bank: parseInt(localStorage.getItem('kcd_bank')) || 0,
        highScore: parseInt(localStorage.getItem('kcd_highScore')) || 0,
        unlocked: JSON.parse(localStorage.getItem('kcd_unlocked')) || ['skin_default'],
        inventory: JSON.parse(localStorage.getItem('kcd_inventory')) || { magnetLvl: 1, shieldLvl: 0, feverLvl: 1 },
        equippedSkin: localStorage.getItem('kcd_skin') || 'skin_default',
        running: false,
        paused: false,
        fever: 0,
        combo: 0,
        magnetActive: 0,
        shieldActive: false,
        coinsCollectedRun: 0
    };

    const SHOP_DATA = [
        { id: 'upg_magnet', type: 'upgrade', name: 'Magnet Power', desc: 'Increases attraction range', price: 150, maxLvl: 5, key: 'magnetLvl', icon: 'üß≤' },
        { id: 'upg_shield', type: 'upgrade', name: 'Cucumber Shield', desc: 'Start with a shield', price: 300, maxLvl: 1, key: 'shieldLvl', icon: 'üõ°Ô∏è' },
        { id: 'upg_fever', type: 'upgrade', name: 'Fever Duration', desc: 'Fever lasts longer', price: 200, maxLvl: 5, key: 'feverLvl', icon: 'üî•' },
        { id: 'skin_tux', type: 'skin', name: 'Gentleman', desc: 'Look fancy', price: 500, icon: 'üé©' },
        { id: 'skin_king', type: 'skin', name: 'Royal Cat', desc: 'Bow down', price: 1000, icon: 'üëë' },
        { id: 'skin_alien', type: 'skin', name: 'Area 51', desc: 'Out of this world', price: 1500, icon: 'üëΩ' },
        { id: 'skin_cool', type: 'skin', name: 'Cool Cat', desc: 'Deal with it', price: 750, icon: 'üï∂Ô∏è' }
    ];

    let width, height;
    let entities = { player: {x:0, y:0}, items: [], particles: [] };
    let spawnTimer = 0;
    let difficulty = 1;
    let mouseX = 0;
    
    // --- AUDIO ENGINE (Web Audio API) ---
    const AudioEngine = {
        ctx: null,
        masterGain: null,
        muted: false,
        nextNoteTime: 0,
        noteIndex: 0,
        melody: [
            {f: 261.63, d: 0.2}, {f: 329.63, d: 0.2}, {f: 392.00, d: 0.2}, {f: 523.25, d: 0.4},
            {f: 392.00, d: 0.2}, {f: 329.63, d: 0.2}, {f: 261.63, d: 0.4},
            {f: 293.66, d: 0.2}, {f: 349.23, d: 0.2}, {f: 440.00, d: 0.2}, {f: 587.33, d: 0.4},
            {f: 440.00, d: 0.2}, {f: 349.23, d: 0.2}, {f: 293.66, d: 0.4}
        ],
        
        init() {
            if (!this.ctx) {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.ctx.createGain();
                this.masterGain.connect(this.ctx.destination);
                this.masterGain.gain.value = 0.3;
                this.scheduleMusic();
            }
            if (this.ctx.state === 'suspended') this.ctx.resume();
        },

        toggleMute() {
            this.muted = !this.muted;
            if(this.masterGain) this.masterGain.gain.value = this.muted ? 0 : 0.3;
            document.getElementById('muteBtn').innerText = this.muted ? 'üîá' : 'üîä';
        },

        playTone(freq, type, duration, vol=0.5) {
            if (this.muted || !this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(this.masterGain);
            osc.start();
            osc.stop(this.ctx.currentTime + duration);
        },

        playNoise(duration) {
            if (this.muted || !this.ctx) return;
            const bufferSize = this.ctx.sampleRate * duration;
            const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

            const noise = this.ctx.createBufferSource();
            noise.buffer = buffer;
            const gain = this.ctx.createGain();
            gain.gain.setValueAtTime(0.5, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            noise.connect(gain);
            gain.connect(this.masterGain);
            noise.start();
        },

        sfxCoin(isFever) {
            const base = isFever ? 880 : 523 + (Math.random() * 100);
            this.playTone(base, 'sine', 0.1, 0.2);
            setTimeout(() => this.playTone(base * 1.5, 'square', 0.1, 0.1), 50);
        },
        
        sfxPowerup() {
            this.playTone(400, 'triangle', 0.1);
            setTimeout(() => this.playTone(600, 'triangle', 0.1), 100);
            setTimeout(() => this.playTone(800, 'triangle', 0.3), 200);
        },

        sfxHit() {
            this.playTone(150, 'sawtooth', 0.4);
            this.playNoise(0.3);
        },

        scheduleMusic() {
            if (!this.ctx) return;
            // Simple scheduler
            setInterval(() => {
                if(!STATE.running || STATE.paused) return;
                const currentTime = this.ctx.currentTime;
                if (currentTime >= this.nextNoteTime) {
                    const note = this.melody[this.noteIndex];
                    this.playTone(note.f, 'triangle', note.d, 0.1);
                    this.nextNoteTime = currentTime + note.d;
                    this.noteIndex = (this.noteIndex + 1) % this.melody.length;
                }
            }, 50);
        }
    };

    // --- GAMEPLAY FUNCTIONS ---
    function init() {
        resize();
        window.addEventListener('resize', resize);
        
        // Inputs
        const inputHandler = (e) => {
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const rect = frame.getBoundingClientRect();
            mouseX = clientX - rect.left;
        };
        frame.addEventListener('mousemove', inputHandler);
        frame.addEventListener('touchmove', inputHandler, {passive: false});
        
        updateMenuUI();
    }

    function resize() {
        const r = frame.getBoundingClientRect();
        canvas.width = r.width;
        canvas.height = r.height;
        width = r.width;
        height = r.height;
    }

    function saveGame() {
        localStorage.setItem('kcd_bank', STATE.bank);
        localStorage.setItem('kcd_highScore', STATE.highScore);
        localStorage.setItem('kcd_unlocked', JSON.stringify(STATE.unlocked));
        localStorage.setItem('kcd_inventory', JSON.stringify(STATE.inventory));
        localStorage.setItem('kcd_skin', STATE.equippedSkin);
    }

    function startGame() {
        AudioEngine.init();
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('gameHUD').style.display = 'block';
        
        // Reset State
        STATE.running = true;
        STATE.paused = false;
        STATE.score = 0;
        STATE.fever = 0;
        STATE.combo = 0;
        STATE.coinsCollectedRun = 0;
        STATE.magnetActive = 0;
        STATE.shieldActive = STATE.inventory.shieldLvl > 0;
        difficulty = 1;
        
        entities.items = [];
        entities.particles = [];
        entities.player = { x: width/2, y: height - 80, w: 60, h: 60 };

        requestAnimationFrame(loop);
    }

    function togglePause() {
        if(!STATE.running) return;
        STATE.paused = !STATE.paused;
        const pScreen = document.getElementById('pauseScreen');
        if(STATE.paused) pScreen.classList.remove('hidden');
        else {
            pScreen.classList.add('hidden');
            requestAnimationFrame(loop);
        }
    }

    function quitGame() {
        STATE.running = false;
        saveGame();
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('gameHUD').style.display = 'none';
        document.getElementById('startScreen').classList.remove('hidden');
        updateMenuUI();
    }

    function gameOver() {
        STATE.running = false;
        AudioEngine.sfxHit();
        
        // Screen Shake
        frame.classList.remove('shake');
        void frame.offsetWidth;
        frame.classList.add('shake');

        if(STATE.score > STATE.highScore) STATE.highScore = STATE.score;
        saveGame();

        document.getElementById('endScore').innerText = STATE.score;
        document.getElementById('endCoins').innerText = "+" + STATE.coinsCollectedRun;
        
        setTimeout(() => {
            document.getElementById('gameHUD').style.display = 'none';
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }, 800);
    }

    // --- GAME LOOP ---
    function loop() {
        if(!STATE.running || STATE.paused) return;

        ctx.clearRect(0,0,width,height);
        
        // Difficulty Scaling
        difficulty = 1 + (STATE.score / 2000);
        spawnTimer--;

        // Spawning
        if(spawnTimer <= 0) {
            spawnItem();
            let spawnRate = 40 - (difficulty * 2);
            if(STATE.fever >= 100) spawnRate = 10;
            spawnTimer = Math.max(10, spawnRate);
        }

        updatePlayer();
        updateItems();
        updateParticles();
        drawHUD();

        requestAnimationFrame(loop);
    }

    function spawnItem() {
        const rand = Math.random();
        let type = 'coin';
        
        if (rand > 0.96) type = 'magnet';
        else if (rand > 0.93 && !STATE.shieldActive) type = 'shield';
        else if (rand > 0.85) type = 'gem';
        else if (rand < 0.2) type = 'cucumber';

        const item = {
            x: Math.random() * (width - 40) + 20,
            y: -50,
            type: type,
            vx: (Math.random() - 0.5) * 2,
            vy: (Math.random() * 2 + 3) * (type === 'cucumber' ? 1.3 : 1) + difficulty,
            rot: Math.random() * 6,
            rotSpeed: (Math.random() - 0.5) * 0.2
        };
        entities.items.push(item);
    }

    function updatePlayer() {
        // Smooth movement
        entities.player.x += (mouseX - entities.player.x) * 0.15;
        
        // Constrain
        if(entities.player.x < 30) entities.player.x = 30;
        if(entities.player.x > width-30) entities.player.x = width-30;

        drawCat(entities.player.x, entities.player.y);
        
        // Magnet Logic
        if(STATE.magnetActive > 0) {
            STATE.magnetActive--;
            document.getElementById('powerupText').innerText = `MAGNET: ${Math.ceil(STATE.magnetActive/60)}s`;
        } else if (STATE.fever < 100) {
            document.getElementById('powerupText').innerText = "";
        }
    }

    function updateItems() {
        const p = entities.player;
        const feverMult = STATE.fever >= 100 ? 2 : 1;

        for(let i = entities.items.length-1; i>=0; i--) {
            let it = entities.items[i];
            
            // Magnet pull
            if (STATE.magnetActive > 0 && it.type !== 'cucumber') {
                it.x += (p.x - it.x) * 0.1;
                it.y += (p.y - it.y) * 0.1;
            }

            it.x += it.vx;
            it.y += it.vy;
            it.rot += it.rotSpeed;

            // Draw
            drawItem(it);

            // Collision
            const dist = Math.hypot(p.x - it.x, (p.y - 20) - it.y);
            
            if (dist < 50) {
                // Caught
                handlePickup(it);
                entities.items.splice(i, 1);
            } else if (it.y > height + 50) {
                // Missed
                if(it.type !== 'cucumber') {
                    STATE.combo = 0; 
                    if(STATE.fever < 100) STATE.fever = Math.max(0, STATE.fever - 10);
                }
                entities.items.splice(i, 1);
            }
        }
        
        // Fever Drain
        if (STATE.fever >= 100) {
            STATE.fever -= 0.2 / (STATE.inventory.feverLvl || 1);
            document.getElementById('powerupText').innerText = "üî• FEVER MODE! üî•";
            if (STATE.fever <= 0) {
                STATE.fever = 0;
            }
        }
    }

    function handlePickup(it) {
        if(it.type === 'cucumber') {
            if (STATE.shieldActive) {
                STATE.shieldActive = false;
                AudioEngine.playNoise(0.1);
                createFloatingText(it.x, it.y, "SHIELD BREAK!", "#aaa");
                createParticles(it.x, it.y, "#fff", 10);
            } else {
                gameOver();
            }
            return;
        }

        STATE.combo++;
        let val = 0;
        let color = '#fff';
        let txt = "";

        if(it.type === 'coin') {
            val = 10 * (1 + (STATE.combo * 0.1));
            color = '#ffca3a';
            txt = `+${Math.floor(val)}`;
            STATE.fever += 5;
            STATE.coinsCollectedRun += 1;
            STATE.bank += 1;
            AudioEngine.sfxCoin(STATE.fever>=100);
        } else if (it.type === 'gem') {
            val = 50 * (1 + (STATE.combo * 0.1));
            color = '#4cc9f0';
            txt = `+${Math.floor(val)}`;
            STATE.fever += 20;
            STATE.coinsCollectedRun += 5;
            STATE.bank += 5;
            AudioEngine.sfxCoin(true);
        } else if (it.type === 'magnet') {
            STATE.magnetActive = 300 + (STATE.inventory.magnetLvl * 60);
            color = '#f72585';
            txt = "MAGNET!";
            AudioEngine.sfxPowerup();
        } else if (it.type === 'shield') {
            STATE.shieldActive = true;
            color = '#70e000';
            txt = "SHIELD!";
            AudioEngine.sfxPowerup();
        }

        if(STATE.fever >= 100 && it.type !== 'magnet' && it.type !== 'shield') {
            val *= 2;
            txt += " x2";
        }

        STATE.score += Math.floor(val);
        createFloatingText(it.x, it.y, txt, color);
        createParticles(it.x, it.y, color, 8);
    }

    function createFloatingText(x, y, text, color) {
        const el = document.createElement('div');
        el.className = 'float-text';
        el.innerText = text;
        el.style.color = color;
        el.style.left = (x + frame.getBoundingClientRect().left) + 'px';
        el.style.top = (y + frame.getBoundingClientRect().top) + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    // --- DRAWING ---
    function drawCat(x, y) {
        ctx.save();
        ctx.translate(x, y);
        
        // Shield Glow
        if(STATE.shieldActive) {
            ctx.beginPath(); ctx.arc(0, 0, 50, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(112, 224, 0, 0.3)'; ctx.fill();
            ctx.strokeStyle = '#70e000'; ctx.lineWidth = 2; ctx.stroke();
        }

        // Body
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.ellipse(0, 10, 40, 30, 0, 0, Math.PI*2); ctx.fill();
        
        // Ears
        ctx.beginPath(); ctx.moveTo(-30, -10); ctx.lineTo(-40, -35); ctx.lineTo(-10, -15); ctx.fill();
        ctx.beginPath(); ctx.moveTo(30, -10); ctx.lineTo(40, -35); ctx.lineTo(10, -15); ctx.fill();
        
        // Inner Ears
        ctx.fillStyle = 'pink';
        ctx.beginPath(); ctx.moveTo(-30, -10); ctx.lineTo(-38, -28); ctx.lineTo(-15, -15); ctx.fill();
        ctx.beginPath(); ctx.moveTo(30, -10); ctx.lineTo(38, -28); ctx.lineTo(15, -15); ctx.fill();

        // Face
        ctx.fillStyle = '#333';
        ctx.beginPath(); ctx.arc(-15, 0, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(15, 0, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(0, 10, 3, 2, 0, 0, Math.PI*2); ctx.fill(); // Nose

        // Hat Rendering
        const skin = STATE.equippedSkin;
        if(skin === 'skin_tux') {
            ctx.fillStyle = '#000'; ctx.fillRect(-25, -45, 50, 30); ctx.fillRect(-35, -15, 70, 5);
            ctx.fillStyle = 'red'; ctx.fillRect(-25, -20, 50, 5);
        } else if (skin === 'skin_king') {
            ctx.fillStyle = 'gold'; ctx.beginPath(); ctx.moveTo(-25,-15); ctx.lineTo(-25,-45); ctx.lineTo(-10,-30); ctx.lineTo(0,-50); ctx.lineTo(10,-30); ctx.lineTo(25,-45); ctx.lineTo(25,-15); ctx.fill();
        } else if (skin === 'skin_cool') {
            ctx.fillStyle = '#000'; ctx.fillRect(-30, -5, 60, 10);
        } else if (skin === 'skin_alien') {
            ctx.fillStyle = '#70e000'; ctx.beginPath(); ctx.arc(0, -30, 5, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle='#70e000'; ctx.beginPath(); ctx.moveTo(0,-15); ctx.lineTo(0,-30); ctx.stroke();
        }

        ctx.restore();
    }

    function drawItem(it) {
        ctx.save();
        ctx.translate(it.x, it.y);
        ctx.rotate(it.rot);

        if (it.type === 'coin') {
            ctx.beginPath(); ctx.arc(0,0, 15, 0, Math.PI*2);
            ctx.fillStyle = '#ffca3a'; ctx.fill();
            ctx.strokeStyle = '#e85d04'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = '#e85d04'; ctx.font='bold 16px Arial'; ctx.textAlign='center'; ctx.fillText('$', 0, 5);
        } else if (it.type === 'cucumber') {
            ctx.fillStyle = '#38b000';
            ctx.beginPath(); ctx.roundRect(-8, -20, 16, 40, 8); ctx.fill();
        } else if (it.type === 'gem') {
            ctx.fillStyle = '#4cc9f0';
            ctx.beginPath(); ctx.moveTo(0,-15); ctx.lineTo(15,0); ctx.lineTo(0,15); ctx.lineTo(-15,0); ctx.fill();
        } else if (it.type === 'magnet') {
            ctx.font = '24px Arial'; ctx.textAlign='center'; ctx.fillText('üß≤',0,10);
        } else if (it.type === 'shield') {
            ctx.font = '24px Arial'; ctx.textAlign='center'; ctx.fillText('üõ°Ô∏è',0,10);
        }
        ctx.restore();
    }

    function createParticles(x, y, color, count) {
        for(let i=0; i<count; i++) {
            entities.particles.push({
                x: x, y: y,
                vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                life: 1, color: color
            });
        }
    }

    function updateParticles() {
        for(let i=entities.particles.length-1; i>=0; i--) {
            let p = entities.particles[i];
            p.x += p.vx; p.y += p.vy;
            p.life -= 0.05;
            
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
            
            if(p.life <= 0) entities.particles.splice(i,1);
        }
        ctx.globalAlpha = 1;
    }

    function drawHUD() {
        document.getElementById('scoreDisplay').innerText = STATE.score;
        document.getElementById('bankDisplayHUD').innerText = STATE.bank;
        
        const feverEl = document.getElementById('feverBar');
        feverEl.style.width = Math.min(STATE.fever, 100) + '%';
        
        if (STATE.fever >= 100) feverEl.parentElement.classList.add('fever-active');
        else feverEl.parentElement.classList.remove('fever-active');

        const comboEl = document.getElementById('comboDisplay');
        if (STATE.combo > 1) {
            comboEl.innerText = `x${1 + Math.floor(STATE.combo/10)} COMBO`;
            comboEl.style.opacity = 1;
        } else {
            comboEl.style.opacity = 0;
        }
    }

    // --- SHOP LOGIC ---
    let currentShopTab = 'upgrades';

    function updateMenuUI() {
        document.getElementById('menuBank').innerText = STATE.bank;
        document.getElementById('shopBank').innerText = STATE.bank;
        document.getElementById('menuHighScore').innerText = STATE.highScore;
    }

    function openShop() {
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('shopScreen').classList.remove('hidden');
        renderShop();
    }

    function closeShop() {
        document.getElementById('shopScreen').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
        updateMenuUI();
    }

    function switchTab(tab) {
        currentShopTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        renderShop();
    }

    function renderShop() {
        const list = document.getElementById('shopList');
        list.innerHTML = '';
        
        const items = SHOP_DATA.filter(i => i.type === (currentShopTab === 'upgrades' ? 'upgrade' : 'skin'));

        items.forEach(item => {
            const el = document.createElement('div');
            el.className = 'shop-item';
            
            let btnText = "BUY";
            let btnClass = "shop-btn";
            let disabled = false;
            let currentLvl = 0;

            if (item.type === 'upgrade') {
                currentLvl = STATE.inventory[item.key] || 0;
                if (currentLvl >= item.maxLvl) {
                    btnText = "MAXED";
                    disabled = true;
                    btnClass += " owned";
                } else {
                    btnText = `${item.price} ü™ô`;
                    if (STATE.bank < item.price) disabled = true;
                }
            } else {
                // Skin
                if (STATE.unlocked.includes(item.id)) {
                    if (STATE.equippedSkin === item.id) {
                        btnText = "EQUIPPED";
                        btnClass += " owned";
                        disabled = true;
                    } else {
                        btnText = "EQUIP";
                        btnClass += " owned";
                    }
                } else {
                    btnText = `${item.price} ü™ô`;
                    if (STATE.bank < item.price) disabled = true;
                }
            }

            el.innerHTML = `
                <div class="shop-icon">${item.icon}</div>
                <div class="shop-info">
                    <div class="shop-name">${item.name} ${item.type === 'upgrade' ? `(Lvl ${currentLvl})` : ''}</div>
                    <div class="shop-desc">${item.desc}</div>
                </div>
                <button class="${btnClass}" ${disabled && btnText !== 'EQUIP' ? 'disabled' : ''} onclick="buyItem('${item.id}')">${btnText}</button>
            `;
            list.appendChild(el);
        });
    }

    function buyItem(id) {
        const item = SHOP_DATA.find(i => i.id === id);
        
        if (item.type === 'upgrade') {
            if (STATE.bank >= item.price) {
                STATE.bank -= item.price;
                STATE.inventory[item.key]++;
                AudioEngine.sfxCoin(true);
            }
        } else {
            // Skin
            if (STATE.unlocked.includes(id)) {
                STATE.equippedSkin = id;
            } else if (STATE.bank >= item.price) {
                STATE.bank -= item.price;
                STATE.unlocked.push(id);
                STATE.equippedSkin = id;
                AudioEngine.sfxCoin(true);
            }
        }
        saveGame();
        renderShop();
        document.getElementById('shopBank').innerText = STATE.bank;
    }

    // Initialize
    init();

</script>
</body>
</html>
