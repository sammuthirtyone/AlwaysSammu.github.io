<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üê± Kitty Coin Rush: Neon Fever</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;900&display=swap');

        :root {
            --primary: #ff8fab;
            --accent: #fb6f92;
            --dark: #2d1b2e;
            --gold: #ffd700;
            --danger: #ff4757;
            --bg: #fff0f5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Fredoka', sans-serif; }

        body {
            background: var(--dark);
            height: 100vh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            touch-action: none;
        }

        #game-frame {
            position: relative;
            width: 100%; max-width: 500px;
            height: 100%; max-height: 900px;
            background: var(--bg);
            overflow: hidden;
            box-shadow: 0 0 80px rgba(0,0,0,0.5);
            transition: filter 0.1s;
        }
        @media(min-width: 500px) {
            #game-frame { height: 95vh; border-radius: 35px; border: 8px solid #333; }
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* --- UI OVERLAYS --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; flex-direction: column;
        }

        .hud-top {
            padding: 15px; display: flex; justify-content: space-between; align-items: flex-start;
        }

        .score-pill {
            background: #fff; padding: 5px 20px; border-radius: 30px;
            box-shadow: 0 5px 0 rgba(0,0,0,0.1);
            font-size: 1.5rem; font-weight: 900; color: var(--dark);
            display: flex; flex-direction: column; align-items: center;
            border: 2px solid var(--primary);
        }
        .score-pill small { font-size: 0.7rem; color: #aaa; letter-spacing: 1px; }

        .hearts-container {
            display: flex; gap: 5px; background: rgba(255,255,255,0.8);
            padding: 8px; border-radius: 20px; backdrop-filter: blur(4px);
        }
        .heart { font-size: 1.5rem; transition: transform 0.2s, filter 0.2s; }
        .heart.lost { filter: grayscale(1) opacity(0.3); transform: scale(0.8); }

        .fever-meter {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 80%; height: 16px; background: rgba(0,0,0,0.2);
            border-radius: 10px; border: 3px solid #fff; overflow: hidden;
        }
        .fever-fill {
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, #ff9a9e, #ff0055);
            transition: width 0.1s linear;
        }
        .fever-active .fever-fill {
            background: linear-gradient(90deg, #f093fb, #f5576c, #4facfe, #00f2fe);
            background-size: 200% 200%;
            animation: gradientAnim 0.5s linear infinite;
        }
        @keyframes gradientAnim { 0%{background-position:0% 50%} 100%{background-position:100% 50%} }

        .combo-text {
            position: absolute; top: 15%; width: 100%; text-align: center;
            font-size: 3rem; font-weight: 900; color: var(--gold);
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2);
            pointer-events: none; opacity: 0; transform: scale(0.5);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .combo-text.show { opacity: 1; transform: scale(1.2) rotate(-5deg); }

        /* --- SCREENS --- */
        .screen {
            position: absolute; inset: 0; background: rgba(255,255,255,0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; transition: opacity 0.3s; pointer-events: auto;
            backdrop-filter: blur(10px);
        }
        .hidden { opacity: 0; pointer-events: none; }

        .btn-big {
            background: linear-gradient(to bottom, #ff758c, #ff7eb3);
            border: none; padding: 15px 50px; border-radius: 50px;
            color: white; font-size: 2rem; font-weight: 900;
            box-shadow: 0 8px 0 #d63031, 0 20px 20px rgba(0,0,0,0.2);
            cursor: pointer; margin: 15px; transform: scale(1); transition: transform 0.1s;
            text-transform: uppercase; text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }
        .btn-big:active { transform: scale(0.95) translateY(8px); box-shadow: 0 0 0 #d63031; }

        /* --- SHOP GRID --- */
        .shop-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            width: 90%; max-height: 50vh; overflow-y: auto; padding: 10px;
        }
        .shop-card {
            background: #fff; border: 3px solid #eee; border-radius: 15px;
            padding: 10px; text-align: center; cursor: pointer; position: relative;
        }
        .shop-card.owned { border-color: #55efc4; background: #e0fbf4; }
        .shop-card.selected { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(251, 111, 146, 0.3); }

        /* --- JUICE CLASSES --- */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-4px, 0, 0); } 20%, 80% { transform: translate3d(8px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-10px, 0, 0); } 40%, 60% { transform: translate3d(10px, 0, 0); } }
        
        .flash { animation: flashAnim 0.2s; }
        @keyframes flashAnim { 0% { filter: brightness(2) sepia(1) hue-rotate(-50deg); } 100% { filter: none; } }

    </style>
</head>
<body>

<div id="game-frame">
    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer" id="gameUI" style="display:none;">
        <div class="hud-top">
            <div class="hearts-container" id="heartsDisplay">
                <div class="heart">‚ù§Ô∏è</div><div class="heart">‚ù§Ô∏è</div><div class="heart">‚ù§Ô∏è</div>
            </div>
            <div class="score-pill">
                <small>SCORE</small>
                <span id="scoreVal">0</span>
            </div>
            <div style="background:var(--gold); border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center; font-weight:bold; border:3px solid #fff; box-shadow:0 4px 0 rgba(0,0,0,0.2); cursor:pointer; pointer-events:auto;" onclick="togglePause()">
                ‚è∏Ô∏è
            </div>
        </div>
        <div class="combo-text" id="comboText">COMBO x5!</div>
        <div class="fever-meter"><div class="fever-fill" id="feverBar"></div></div>
    </div>

    <div class="screen" id="menuScreen">
        <div style="font-size:5rem; animation: bounce 1s infinite alternate;">üòª</div>
        <h1 style="font-size:3.5rem; text-align:center; color:var(--accent); line-height:1; margin-bottom:10px; text-shadow:3px 3px 0 #fff;">KITTY<br>COIN<br>RUSH</h1>
        <div style="background:#fff; padding:5px 20px; border-radius:20px; margin-bottom:20px; font-weight:bold; color:var(--dark);">
            ü™ô BANK: <span id="bankVal">0</span>
        </div>
        <button class="btn-big" onclick="startGame()">PLAY</button>
        <div style="display:flex; gap:15px; margin-top:20px;">
            <button class="btn-big" style="font-size:1.5rem; padding:15px;" onclick="openShop()">üõí SHOP</button>
            <button class="btn-big" style="font-size:1.5rem; padding:15px;" onclick="toggleMute()" id="muteBtn">üîä</button>
        </div>
    </div>

    <div class="screen hidden" id="shopScreen">
        <h2>POWER-UPS & SKINS</h2>
        <div style="margin-bottom:10px;">ü™ô <span id="shopBank">0</span></div>
        <div class="shop-grid" id="shopContent"></div>
        <button class="btn-big" style="font-size:1.2rem; padding:10px 40px;" onclick="closeShop()">CLOSE</button>
    </div>

    <div class="screen hidden" id="gameOverScreen">
        <h1 style="color:var(--danger); font-size:3.5rem;">OUCH!</h1>
        <div style="font-size:1.2rem; margin-bottom:10px;">SCORE: <span id="finalScore">0</span></div>
        <div style="font-size:1.5rem; color:var(--gold); font-weight:bold; margin-bottom:30px;">EARNED: +<span id="finalCoins">0</span> ü™ô</div>
        <button class="btn-big" onclick="startGame()">RETRY üîÑ</button>
        <button class="btn-big" style="background:#eee; color:#555; box-shadow:0 6px 0 #ccc; font-size:1.2rem;" onclick="goHome()">MENU</button>
    </div>
</div>

<script>
/** * AUDIO SYSTEM - Procedural Synthesizer 
 * No external assets needed.
 */
const Audio = {
    ctx: null,
    muted: false,
    init() {
        if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    },
    playTone(freq, type, duration, vol=0.1, slide=0) {
        if(this.muted || !this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if(slide) osc.frequency.linearRampToValueAtTime(freq+slide, this.ctx.currentTime + duration);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + duration);
    },
    coin(combo) {
        const base = 800 + (combo * 50); 
        this.playTone(base, 'sine', 0.1, 0.1);
        setTimeout(() => this.playTone(base * 1.5, 'square', 0.1, 0.05), 50);
    },
    hurt() {
        this.playTone(150, 'sawtooth', 0.3, 0.3, -50);
        this.playTone(100, 'square', 0.3, 0.3, -50);
    },
    powerup() {
        this.playTone(400, 'triangle', 0.5, 0.2, 800);
    },
    beat(tick) {
        if(tick % 8 === 0) this.playTone(100, 'square', 0.05, 0.05, -20); // Kick
        if(tick % 8 === 4) this.playTone(200, 'triangle', 0.05, 0.02); // Snare
    }
};

/** GAME ENGINE */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', {alpha: false});
const frame = document.getElementById('game-frame');

// State
let STATE = {
    running: false,
    paused: false,
    width: 0, height: 0,
    frames: 0,
    score: 0,
    bank: parseInt(localStorage.getItem('kcr_bank')) || 0,
    unlocked: JSON.parse(localStorage.getItem('kcr_skins')) || ['default'],
    upgrades: JSON.parse(localStorage.getItem('kcr_upgrades')) || { magnet: 0, hearts: 0 },
    skin: localStorage.getItem('kcr_currentSkin') || 'default',
    coinsRun: 0,
    hearts: 3,
    fever: 0,
    combo: 0,
    difficulty: 1,
    isFever: false,
    magnetTimer: 0
};

// Entities
let player = { x: 0, y: 0, vx: 0, w: 60, h: 50, scaleX: 1, scaleY: 1, trail: [] };
let items = [];
let particles = [];
let mouseX = 0;

// Shop Data
const SHOP = [
    { id: 'u_magnet', type: 'upg', name: 'Magnet Lvl', cost: 200, max: 5, key: 'magnet', icon: 'üß≤' },
    { id: 'u_heart', type: 'upg', name: 'Start Hearts', cost: 500, max: 2, key: 'hearts', icon: '‚ù§Ô∏è' },
    { id: 's_cool', type: 'skin', name: 'Cool Cat', cost: 300, icon: 'üòé' },
    { id: 's_alien', type: 'skin', name: 'Alien', cost: 600, icon: 'üëΩ' },
    { id: 's_king', type: 'skin', name: 'King', cost: 1000, icon: 'üëë' },
    { id: 's_ninja', type: 'skin', name: 'Ninja', cost: 800, icon: 'ü•∑' }
];

function init() {
    window.addEventListener('resize', resize);
    resize();
    updateMenu();
    
    // Input Handling
    const handleInput = (x) => {
        const rect = frame.getBoundingClientRect();
        mouseX = Math.max(30, Math.min(STATE.width - 30, x - rect.left));
    };
    frame.addEventListener('mousemove', e => handleInput(e.clientX));
    frame.addEventListener('touchmove', e => { e.preventDefault(); handleInput(e.touches[0].clientX); }, {passive:false});
    
    requestAnimationFrame(loop);
}

function resize() {
    const r = frame.getBoundingClientRect();
    canvas.width = STATE.width = r.width;
    canvas.height = STATE.height = r.height;
    player.y = STATE.height - 80;
    if(!STATE.running) player.x = STATE.width/2;
}

function save() {
    localStorage.setItem('kcr_bank', STATE.bank);
    localStorage.setItem('kcr_skins', JSON.stringify(STATE.unlocked));
    localStorage.setItem('kcr_upgrades', JSON.stringify(STATE.upgrades));
    localStorage.setItem('kcr_currentSkin', STATE.skin);
}

/* --- GAMEPLAY LOOPS --- */

function startGame() {
    Audio.init();
    STATE.running = true; STATE.paused = false;
    STATE.score = 0; STATE.coinsRun = 0; STATE.frames = 0;
    STATE.fever = 0; STATE.combo = 0; STATE.isFever = false;
    STATE.hearts = 3 + (STATE.upgrades.hearts || 0);
    STATE.magnetTimer = 0;
    STATE.difficulty = 1;
    
    items = []; particles = [];
    player.x = STATE.width/2; mouseX = player.x; player.trail = [];
    
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('gameOverScreen').classList.add('hidden');
    document.getElementById('gameUI').style.display = 'flex';
    updateHUD();
}

function spawnWave() {
    const type = Math.random();
    // Pattern Spawning
    if (STATE.isFever || type > 0.7) {
        // Line Pattern
        const startX = Math.random() * (STATE.width - 100) + 50;
        for(let i=0; i<5; i++) {
            items.push(createItem(startX + (Math.sin(i)*20), -50 - (i*60), 'coin'));
        }
    } else if (type > 0.4) {
        // V Pattern
        const cx = Math.random() * (STATE.width - 100) + 50;
        items.push(createItem(cx, -50, 'coin'));
        items.push(createItem(cx-40, -100, 'coin'));
        items.push(createItem(cx+40, -100, 'coin'));
    } else {
        // Random
        items.push(createItem(Math.random() * (STATE.width-40)+20, -50, Math.random()>0.9 ? 'bomb' : 'coin'));
    }

    // Powerups
    if(Math.random() > 0.98) items.push(createItem(Math.random() * (STATE.width-40)+20, -100, 'magnet'));
    if(Math.random() > 0.99 && STATE.hearts < 5) items.push(createItem(Math.random() * (STATE.width-40)+20, -100, 'heart'));
}

function createItem(x, y, type) {
    return { x, y, type, vy: 0, rot: Math.random(), collected: false };
}

function updateHUD() {
    document.getElementById('scoreVal').innerText = Math.floor(STATE.score);
    const heartsDiv = document.getElementById('heartsDisplay');
    heartsDiv.innerHTML = '';
    for(let i=0; i< (3 + (STATE.upgrades.hearts||0)); i++) {
        const h = document.createElement('div');
        h.className = i < STATE.hearts ? 'heart' : 'heart lost';
        h.innerText = '‚ù§Ô∏è';
        heartsDiv.appendChild(h);
    }
    
    const feverEl = document.getElementById('feverBar');
    feverEl.style.width = STATE.fever + '%';
    if(STATE.fever >= 100) feverEl.parentElement.classList.add('fever-active');
    else feverEl.parentElement.classList.remove('fever-active');
}

function loop() {
    if(!STATE.running || STATE.paused) {
        if(STATE.running) requestAnimationFrame(loop); // Keep loop ready if paused
        return;
    }
    
    STATE.frames++;
    
    // Logic
    // 1. Difficulty & Spawning
    STATE.difficulty = 1 + (STATE.score / 5000);
    const spawnRate = STATE.isFever ? 10 : Math.max(20, 60 - (STATE.difficulty * 5));
    if (STATE.frames % Math.floor(spawnRate) === 0) spawnWave();

    // 2. Music Beat
    if(STATE.frames % (STATE.isFever ? 10 : 20) === 0) Audio.beat(STATE.frames);

    // 3. Player Movement (Squash & Stretch)
    const dx = mouseX - player.x;
    player.x += dx * 0.2;
    // Calculate stretch based on velocity
    player.scaleX = 1 + Math.min(Math.abs(dx)*0.01, 0.4);
    player.scaleY = 1 - Math.min(Math.abs(dx)*0.01, 0.3);
    
    // Trail
    if(STATE.frames % 3 === 0) player.trail.push({x: player.x, y: player.y, alpha: 0.6});
    
    // Magnet
    if(STATE.magnetTimer > 0) STATE.magnetTimer--;

    // 4. Fever Logic
    if(STATE.fever >= 100 && !STATE.isFever) {
        STATE.isFever = true;
        Audio.powerup();
        updateHUD();
    } else if (STATE.isFever) {
        STATE.fever -= 0.3;
        if(STATE.fever <= 0) { STATE.isFever = false; STATE.fever = 0; updateHUD(); }
    }

    // Drawing
    ctx.clearRect(0, 0, STATE.width, STATE.height);
    
    // Background Disco
    if(STATE.isFever) {
        ctx.fillStyle = `hsla(${STATE.frames % 360}, 60%, 20%, 0.2)`;
        ctx.fillRect(0,0,STATE.width, STATE.height);
    } else {
        ctx.fillStyle = '#fff0f5';
        ctx.fillRect(0,0,STATE.width, STATE.height);
    }

    // Draw Trail
    for(let i=player.trail.length-1; i>=0; i--) {
        let t = player.trail[i];
        t.alpha -= 0.05;
        ctx.fillStyle = `rgba(255, 143, 171, ${t.alpha})`;
        ctx.beginPath(); ctx.arc(t.x, t.y, 20, 0, Math.PI*2); ctx.fill();
        if(t.alpha <= 0) player.trail.splice(i, 1);
    }

    // Update Items
    for(let i=items.length-1; i>=0; i--) {
        let it = items[i];
        let speed = (5 + STATE.difficulty) * (STATE.isFever ? 2 : 1);
        
        // Magnet Pull
        if(STATE.magnetTimer > 0 && it.type === 'coin') {
            it.x += (player.x - it.x) * 0.15;
            it.y += (player.y - it.y) * 0.15;
        }

        it.y += speed;
        it.rot += 0.1;

        // Draw
        ctx.save();
        ctx.translate(it.x, it.y);
        ctx.rotate(it.rot);
        if(it.type === 'coin') {
            ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#e1b12c'; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle='#e1b12c'; ctx.font='bold 16px Arial'; ctx.textAlign='center'; ctx.fillText('$',0,6);
        } else if(it.type === 'bomb') {
            ctx.fillStyle = '#444'; ctx.beginPath(); ctx.arc(0,0,18,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = 'red'; ctx.font='20px Arial'; ctx.textAlign='center'; ctx.fillText('‚ò†Ô∏è',0,7);
        } else if(it.type === 'magnet') {
            ctx.font='30px Arial'; ctx.textAlign='center'; ctx.fillText('üß≤',0,10);
        } else if(it.type === 'heart') {
            ctx.font='30px Arial'; ctx.textAlign='center'; ctx.fillText('üíñ',0,10);
        }
        ctx.restore();

        // Collision
        let dist = Math.hypot(player.x - it.x, player.y - it.y - 20);
        if(dist < 50) {
            collectItem(it);
            items.splice(i, 1);
        } else if(it.y > STATE.height + 50) {
            if(it.type === 'coin') STATE.combo = 0; // Combo Breaker
            items.splice(i, 1);
        }
    }

    drawCat(player.x, player.y, player.scaleX, player.scaleY);
    drawParticles();

    // UI Updates
    const comboEl = document.getElementById('comboText');
    if(STATE.combo > 5) {
        comboEl.classList.add('show');
        comboEl.innerText = `${STATE.combo} COMBO!`;
        comboEl.style.color = `hsl(${STATE.frames * 5}, 100%, 50%)`;
    } else {
        comboEl.classList.remove('show');
    }

    requestAnimationFrame(loop);
}

function drawCat(x, y, sx, sy) {
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(sx, sy);
    
    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.1)';
    ctx.beginPath(); ctx.ellipse(0, 30, 30, 10, 0, 0, Math.PI*2); ctx.fill();

    // Body
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.ellipse(0, 0, 40, 35, 0, 0, Math.PI*2); ctx.fill();
    
    // Skin features
    if(STATE.skin === 's_ninja') {
        ctx.fillStyle = '#333';
        ctx.beginPath(); ctx.fillRect(-40, -10, 80, 20);
    } else if(STATE.skin === 's_alien') {
        ctx.fillStyle = '#78e08f';
        ctx.beginPath(); ctx.ellipse(0, 0, 40, 35, 0, 0, Math.PI*2); ctx.fill();
    }

    // Ears
    ctx.fillStyle = STATE.skin === 's_alien' ? '#78e08f' : '#fff';
    ctx.beginPath(); ctx.moveTo(-35, -15); ctx.lineTo(-45, -45); ctx.lineTo(-15, -25); ctx.fill();
    ctx.beginPath(); ctx.moveTo(35, -15); ctx.lineTo(45, -45); ctx.lineTo(15, -25); ctx.fill();

    // Face
    ctx.fillStyle = '#333';
    ctx.beginPath(); ctx.arc(-15, -5, 5, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(15, -5, 5, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(0, 5, 4, 3, 0, 0, Math.PI*2); ctx.fill();

    // Accessories
    if(STATE.skin === 's_cool') ctx.fillText('üï∂Ô∏è', -25, 5);
    if(STATE.skin === 's_king') ctx.fillText('üëë', -25, -45);

    ctx.restore();
}

function collectItem(it) {
    if(it.type === 'coin') {
        STATE.combo++;
        let val = 10 * (STATE.isFever ? 3 : 1) + STATE.combo;
        STATE.score += val;
        STATE.bank += 1;
        STATE.coinsRun++;
        if(!STATE.isFever) STATE.fever = Math.min(100, STATE.fever + 5);
        Audio.coin(STATE.combo);
        spawnParticles(it.x, it.y, '#ffd700', 5);
        updateHUD();
    } else if (it.type === 'bomb') {
        takeDamage();
    } else if (it.type === 'magnet') {
        STATE.magnetTimer = 300 + (STATE.upgrades.magnet * 100);
        Audio.powerup();
        spawnParticles(it.x, it.y, '#ff00ff', 10);
    } else if (it.type === 'heart') {
        STATE.hearts = Math.min(5, STATE.hearts + 1);
        Audio.powerup();
        updateHUD();
    }
}

function takeDamage() {
    if(STATE.isFever) return; // Invincible during fever
    STATE.hearts--;
    STATE.combo = 0;
    Audio.hurt();
    
    // Screen Juice
    frame.classList.remove('shake'); void frame.offsetWidth; frame.classList.add('shake');
    frame.classList.remove('flash'); void frame.offsetWidth; frame.classList.add('flash');
    
    updateHUD();
    if(STATE.hearts <= 0) gameOver();
}

function spawnParticles(x, y, color, count) {
    for(let i=0; i<count; i++) {
        particles.push({
            x, y, 
            vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
            life: 1, color
        });
    }
}

function drawParticles() {
    for(let i=particles.length-1; i>=0; i--) {
        let p = particles[i];
        p.x += p.vx; p.y += p.vy; p.life -= 0.05;
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
        if(p.life <= 0) particles.splice(i, 1);
    }
}

function gameOver() {
    STATE.running = false;
    save();
    document.getElementById('finalScore').innerText = Math.floor(STATE.score);
    document.getElementById('finalCoins').innerText = STATE.coinsRun;
    document.getElementById('gameUI').style.display = 'none';
    document.getElementById('gameOverScreen').classList.remove('hidden');
}

/* --- UI FUNCTIONS --- */
function updateMenu() {
    document.getElementById('bankVal').innerText = STATE.bank;
    document.getElementById('shopBank').innerText = STATE.bank;
}

function openShop() {
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('shopScreen').classList.remove('hidden');
    renderShop();
}

function closeShop() {
    document.getElementById('shopScreen').classList.add('hidden');
    document.getElementById('menuScreen').classList.remove('hidden');
    updateMenu();
}

function renderShop() {
    const grid = document.getElementById('shopContent');
    grid.innerHTML = '';
    SHOP.forEach(item => {
        const div = document.createElement('div');
        const isUpg = item.type === 'upg';
        const lvl = isUpg ? (STATE.upgrades[item.key] || 0) : 0;
        const owned = !isUpg && STATE.unlocked.includes(item.id);
        const maxed = isUpg && lvl >= item.max;
        const selected = STATE.skin === item.id;
        
        div.className = `shop-card ${owned || maxed ? 'owned' : ''} ${selected ? 'selected' : ''}`;
        div.innerHTML = `
            <div style="font-size:3rem">${item.icon}</div>
            <strong>${item.name}</strong><br>
            <small>${isUpg ? 'Lvl '+lvl : (owned ? 'OWNED' : item.cost+' ü™ô')}</small>
        `;
        div.onclick = () => buyItem(item);
        grid.appendChild(div);
    });
}

function buyItem(item) {
    if(item.type === 'upg') {
        const lvl = STATE.upgrades[item.key] || 0;
        if(lvl < item.max && STATE.bank >= item.cost) {
            STATE.bank -= item.cost;
            STATE.upgrades[item.key] = lvl + 1;
            Audio.coin(10);
            save(); renderShop(); updateMenu();
        }
    } else {
        if(STATE.unlocked.includes(item.id)) {
            STATE.skin = item.id;
            save(); renderShop();
        } else if(STATE.bank >= item.cost) {
            STATE.bank -= item.cost;
            STATE.unlocked.push(item.id);
            STATE.skin = item.id;
            Audio.coin(10);
            save(); renderShop(); updateMenu();
        }
    }
    document.getElementById('shopBank').innerText = STATE.bank;
}

function goHome() {
    document.getElementById('gameOverScreen').classList.add('hidden');
    document.getElementById('menuScreen').classList.remove('hidden');
    updateMenu();
}

function togglePause() {
    STATE.paused = !STATE.paused;
}

function toggleMute() {
    Audio.muted = !Audio.muted;
    document.getElementById('muteBtn').innerText = Audio.muted ? 'üîá' : 'üîä';
}

init();
</script>
</body>
</html>
