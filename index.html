<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kitty Coin Catcher: Musical Edition</title>
    <meta name="description" content="Catch coins, avoid bombs! Now with cute background music!">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        :root {
            --primary: #ff8fa3;
            --secondary: #5e548e;
            --accent: #ffb703;
            --bg-grad: linear-gradient(180deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Fredoka', sans-serif; }
        
        body {
            background: #1a1a2e;
            height: 100vh; width: 100vw;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }

        .game-container {
            position: relative;
            width: 100%; height: 100%;
            max-width: 600px; max-height: 900px;
            background: var(--bg-grad);
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        @media (min-width: 601px) { .game-container { border-radius: 24px; height: 95vh; } }

        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        .hud {
            padding: 20px; display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: auto;
        }

        .stat-pill {
            background: #fff; padding: 8px 16px; border-radius: 50px;
            border: 3px solid #fff;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            color: var(--secondary); font-weight: 700; font-size: 1.2rem;
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 10px;
        }

        .btn-round {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: #fff; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 4px 0 #c8b6ff; color: var(--secondary);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.1s;
        }
        .btn-round:active { transform: translateY(4px); box-shadow: none; }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; padding: 20px;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: auto;
        }
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        h1 { 
            font-size: 3.5rem; color: var(--primary); text-align: center; 
            line-height: 1; text-shadow: 3px 3px 0 #fff; margin-bottom: 30px; 
            animation: bounce 2s infinite;
        }

        .btn-main {
            background: linear-gradient(to bottom, #ff8fa3, #ff5d8f);
            border: none; padding: 18px 60px; border-radius: 60px;
            font-size: 2rem; color: white; font-weight: 800; cursor: pointer;
            box-shadow: 0 8px 0 #c9184a, 0 15px 20px rgba(255, 93, 143, 0.4);
            margin: 10px; transition: 0.1s; width: 80%; max-width: 350px;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .btn-main:active { transform: translateY(8px); box-shadow: 0 0 0 #c9184a; }
        
        .btn-sec {
            background: #fff; color: var(--secondary);
            border: 3px solid #efefef; padding: 12px 40px; border-radius: 40px;
            font-size: 1.3rem; font-weight: 700; cursor: pointer;
            box-shadow: 0 5px 0 #ddd; margin-top: 15px;
        }
        .btn-sec:active { transform: translateY(5px); box-shadow: none; }

        /* Shop Grid */
        .shop-container {
            background: #fff; border-radius: 20px; padding: 20px;
            width: 100%; max-width: 400px; max-height: 60vh;
            overflow-y: auto;
        }
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .shop-item {
            background: #f8f9fa; padding: 15px; border-radius: 15px;
            text-align: center; border: 3px solid transparent;
            cursor: pointer; transition: 0.2s;
        }
        .shop-item.owned { background: #e2eafc; }
        .shop-item.equipped { border-color: var(--primary); background: #ffe5ec; }
        .shop-item.locked { opacity: 0.6; filter: grayscale(1); }
        .shop-item:active { transform: scale(0.95); }

        canvas { display: block; width: 100%; height: 100%; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translateX(-4px); } 50% { transform: translateX(4px); } }
    </style>
</head>
<body>

<div class="game-container" id="gameContainer">
    <div class="ui-layer">
        <div class="hud">
            <div>
                <div class="stat-pill" style="color: #ffb703;">ü™ô <span id="uiScore">0</span></div>
                <div class="stat-pill" style="color: #ff5d8f;" id="uiLives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>
            <button class="btn-round" id="btnPause">II</button>
        </div>
        
        <div style="position:absolute; bottom:20px; width:100%; text-align:center; opacity:0.8; font-weight:600; color: white; text-shadow: 1px 1px 0 rgba(0,0,0,0.2);">
            <span id="controlHint">Slide or Arrow Keys</span>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div class="screen" id="screenStart">
        <h1>KITTY<br>CATCH</h1>
        <button class="btn-main" id="btnPlay">PLAY</button>
        <button class="btn-sec" id="btnShop">üëó SKINS</button>
        <div style="margin-top:20px; display:flex; gap:20px;">
            <button class="btn-round" id="btnMute">üéµ</button>
        </div>
    </div>

    <div class="screen hidden" id="screenShop">
        <div class="hud" style="width:100%; position: absolute; top:0;">
            <button class="btn-round" id="btnCloseShop">‚úï</button>
            <div class="stat-pill">Wallet: <span id="uiWallet">0</span></div>
        </div>
        <h2 style="color:var(--secondary); margin-top: 60px; margin-bottom: 20px;">WARDROBE</h2>
        <div class="shop-container">
            <div class="shop-grid" id="shopGrid"></div>
        </div>
    </div>

    <div class="screen hidden" id="screenOver">
        <h1 style="font-size: 2.5rem; margin-bottom: 10px;">GAME OVER</h1>
        <div style="font-size: 4rem; font-weight:800; color:var(--primary); margin-bottom: 10px;">
            <span id="uiFinalScore">0</span>
        </div>
        <p style="color:#666; font-weight:bold; margin-bottom:30px;">BEST: <span id="uiBestScore">0</span></p>
        <button class="btn-main" id="btnRestart">AGAIN!</button>
        <button class="btn-sec" id="btnHome">MENU</button>
    </div>

    <div class="screen hidden" id="screenPause">
        <h1>PAUSED</h1>
        <button class="btn-main" id="btnResume">RESUME</button>
        <button class="btn-sec" id="btnQuit">QUIT</button>
    </div>
</div>

<script>
/**
 * KITTY CATCH - CRAZYGAMES EDITION
 * Features: Procedural Music, Canvas Graphics, Mobile Optimized
 */

// --- CONFIGURATION ---
const CONSTANTS = {
    PLAYER_WIDTH: 70,
    PLAYER_HEIGHT: 55,
    COLORS: { coin: '#ffb703', bomb: '#ef233c', heart: '#ff8fa3' }
};

const SKINS = [
    { id: 'classic', name: 'Classic', cost: 0, color: '#ffcdb2' },
    { id: 'calico', name: 'Calico', cost: 100, color: '#e0aaff' },
    { id: 'void', name: 'Void', cost: 300, color: '#343a40' },
    { id: 'tiger', name: 'Tiger', cost: 500, color: '#ff9f1c' },
    { id: 'alien', name: 'Gnarp', cost: 1000, color: '#70e000' },
    { id: 'robo', name: 'Mecha', cost: 2000, color: '#adb5bd' }
];

const State = {
    screen: 'start', 
    score: 0,
    lives: 3,
    coins: 0,
    bestScore: 0,
    inventory: ['classic'],
    equipped: 'classic',
    settings: { sound: true }
};

// --- ADVANCED AUDIO ENGINE (Music + SFX) ---
const AudioSys = (() => {
    let ctx = null;
    let masterGain = null;
    let musicTimer = null;
    let isInit = false;
    let musicStep = 0;

    // Musical Notes (Frequencies)
    const N = { 
        C4: 261.63, D4: 293.66, E4: 329.63, F4: 349.23, G4: 392.00, A4: 440.00, B4: 493.88,
        C5: 523.25, D5: 587.33, E5: 659.25, F5: 698.46, G5: 783.99, A5: 880.00
    };

    // The Song Pattern (16 steps)
    const BASS_LINE = [N.C4, 0, N.C4, 0, N.F4, 0, N.F4, 0, N.G4, 0, N.G4, 0, N.C4, 0, N.G4, 0];
    const LEAD_LINE = [N.E5, N.G5, N.C5, 0, N.A5, N.F5, N.C5, 0, N.B4, N.D5, N.G5, 0, N.C5, N.E5, N.G5, 0];

    function init() {
        if (isInit) return;
        const AC = window.AudioContext || window.webkitAudioContext;
        ctx = new AC();
        masterGain = ctx.createGain();
        masterGain.gain.value = 0.3; // Master Volume
        masterGain.connect(ctx.destination);
        isInit = true;
    }

    function playTone(freq, type, dur, vol, slide=0) {
        if (!State.settings.sound || !ctx) return;
        const t = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.type = type;
        osc.frequency.setValueAtTime(freq, t);
        if (slide) osc.frequency.exponentialRampToValueAtTime(slide, t + dur);
        
        gain.gain.setValueAtTime(vol, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + dur);
        
        osc.connect(gain);
        gain.connect(masterGain);
        osc.start();
        osc.stop(t + dur);
    }

    function playMusicStep() {
        if (!State.settings.sound || !ctx) return;
        
        // Tempo: 150ms per step (approx 100 BPM eighth notes)
        const stepTime = 0.15; 
        const nextTime = ctx.currentTime;

        // Bass
        const bassFreq = BASS_LINE[musicStep % BASS_LINE.length];
        if (bassFreq) playTone(bassFreq, 'triangle', 0.1, 0.1);

        // Lead
        const leadFreq = LEAD_LINE[musicStep % LEAD_LINE.length];
        if (leadFreq) playTone(leadFreq, 'sine', 0.1, 0.05);

        // Drums (White Noise Snare on beats 4, 8, 12, 16)
        if (musicStep % 4 === 0) {
            // Tiny kick
            playTone(100, 'square', 0.05, 0.05, 50);
        }

        musicStep++;
        musicTimer = setTimeout(playMusicStep, stepTime * 1000);
    }

    return {
        init: init,
        resume: () => { if(ctx && ctx.state === 'suspended') ctx.resume(); },
        startMusic: () => {
            if (musicTimer) clearTimeout(musicTimer);
            musicStep = 0;
            playMusicStep();
        },
        stopMusic: () => {
            if (musicTimer) clearTimeout(musicTimer);
            musicTimer = null;
        },
        // SFX
        playJump: () => playTone(300, 'sine', 0.15, 0.1, 400),
        playCoin: () => {
            playTone(1200, 'sine', 0.1, 0.1); 
            setTimeout(() => playTone(1800, 'sine', 0.2, 0.05), 60);
        },
        playBomb: () => playTone(150, 'sawtooth', 0.4, 0.2, 50),
        playLife: () => playTone(400, 'triangle', 0.3, 0.2, 800)
    };
})();

// --- GAME ENGINE ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
let lastTime = 0;

// Entities
const player = { x: 0, y: 0, targetX: 0, w: CONSTANTS.PLAYER_WIDTH, h: CONSTANTS.PLAYER_HEIGHT, squash: 1 };
let entities = []; 
let particles = [];
let floaters = []; 
let clouds = []; 

// --- HELPERS ---
const rand = (min, max) => Math.random() * (max - min) + min;
const lerp = (a, b, t) => a + (b - a) * t;

function resize() {
    const container = document.getElementById('gameContainer');
    const dpr = window.devicePixelRatio || 1;
    const rect = container.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    canvas.logicalWidth = rect.width;
    canvas.logicalHeight = rect.height;
    player.y = canvas.logicalHeight - 100;
    if(State.screen === 'start') player.x = canvas.logicalWidth/2 - player.w/2;
}

// --- LOGIC ---
function spawnEntity() {
    const roll = Math.random();
    let type = 'coin';
    if (roll > 0.85) type = 'bomb';
    else if (roll > 0.82 && State.lives < 3) type = 'heart';

    entities.push({
        x: rand(20, canvas.logicalWidth - 40),
        y: -50,
        type: type,
        w: type === 'bomb' ? 35 : 28,
        h: type === 'bomb' ? 35 : 28,
        speed: rand(200, 350) + (State.score * 3),
        rot: rand(0, 360),
        rotSpeed: rand(-3, 3)
    });
}

function update(dt) {
    // Player Motion
    const prevX = player.x;
    player.x = lerp(player.x, player.targetX, 10 * dt);
    if (player.x < 0) player.x = 0;
    if (player.x > canvas.logicalWidth - player.w) player.x = canvas.logicalWidth - player.w;

    // Squash Animation
    const vel = Math.abs(player.x - prevX);
    player.squash = lerp(player.squash, 1.0 - Math.min(vel * 0.005, 0.2), 10 * dt);

    // Spawning
    if (Math.random() < 0.02 + (State.score * 0.0001)) spawnEntity();
    if (Math.random() < 0.005 && clouds.length < 5) clouds.push({
        x: -100, y: rand(20, canvas.logicalHeight/2), speed: rand(10, 30), size: rand(30, 60)
    });

    // Entities
    for (let i = entities.length - 1; i >= 0; i--) {
        let e = entities[i];
        e.y += e.speed * dt;
        e.rot += e.rotSpeed * dt;

        // Collision
        const padding = e.type === 'bomb' ? 10 : -15; 
        if (
            e.y + e.h > player.y + 10 &&
            e.y < player.y + player.h &&
            e.x + e.w > player.x + padding &&
            e.x < player.x + player.w - padding
        ) {
            handleCollision(e);
            entities.splice(i, 1);
            continue;
        }
        if (e.y > canvas.logicalHeight) entities.splice(i, 1);
    }

    // Particles/Floaters/Clouds
    particles.forEach(p => { p.x += p.vx * dt; p.y += p.vy * dt; p.life -= dt * 2; });
    particles = particles.filter(p => p.life > 0);
    
    floaters.forEach(f => { f.y -= 50 * dt; f.life -= dt; });
    floaters = floaters.filter(f => f.life > 0);

    clouds.forEach(c => c.x += c.speed * dt);
    clouds = clouds.filter(c => c.x < canvas.logicalWidth + 150);
}

function handleCollision(e) {
    if (e.type === 'coin') {
        State.score += 10;
        AudioSys.playCoin();
        createParticles(e.x, e.y, CONSTANTS.COLORS.coin);
        addFloater(e.x, e.y, "+10", "#fff");
    } else if (e.type === 'bomb') {
        State.lives--;
        AudioSys.playBomb();
        createParticles(e.x, e.y, CONSTANTS.COLORS.bomb);
        addFloater(e.x, e.y, "OUCH", CONSTANTS.COLORS.bomb);
        document.getElementById('gameContainer').classList.remove('shake');
        void document.getElementById('gameContainer').offsetWidth;
        document.getElementById('gameContainer').classList.add('shake');
        if (State.lives <= 0) endGame();
    } else if (e.type === 'heart') {
        State.lives++;
        AudioSys.playLife();
        addFloater(e.x, e.y, "‚ù§Ô∏è", CONSTANTS.COLORS.heart);
    }
    updateUI();
}

function createParticles(x, y, color) {
    for(let i=0; i<8; i++) particles.push({ x, y, vx: rand(-150,150), vy: rand(-150,150), life: 1.0, color, size: rand(3,8) });
}
function addFloater(x, y, text, color) {
    floaters.push({x, y, text, color, life: 0.8});
}

// --- DRAWING ---
function draw() {
    // BG
    ctx.fillStyle = '#C8B6FF'; 
    ctx.fillRect(0, 0, canvas.logicalWidth, canvas.logicalHeight);
    
    // Clouds
    ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
    clouds.forEach(c => {
        ctx.beginPath(); ctx.arc(c.x, c.y, c.size, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(c.x+c.size, c.y, c.size*0.8, 0, Math.PI*2); ctx.fill();
    });

    // Player
    const skin = SKINS.find(s => s.id === State.equipped);
    const px = player.x, py = player.y + (player.h * (1-player.squash));
    const pw = player.w, ph = player.h * player.squash;

    ctx.save();
    ctx.translate(px + pw/2, py + ph/2);
    
    // Cat Body
    ctx.fillStyle = skin.color;
    ctx.beginPath(); ctx.roundRect(-pw/2, -ph/2, pw, ph, 15); ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.lineWidth = 3; ctx.stroke();

    // Ears
    ctx.beginPath();
    ctx.moveTo(-pw/2+5, -ph/2+5); ctx.lineTo(-pw/2-5, -ph/2-15); ctx.lineTo(-pw/2+25, -ph/2+5);
    ctx.moveTo(pw/2-5, -ph/2+5); ctx.lineTo(pw/2+5, -ph/2-15); ctx.lineTo(pw/2-25, -ph/2+5);
    ctx.fill();

    // Face
    const look = (player.targetX - player.x) * 0.05;
    ctx.fillStyle = "#333";
    ctx.beginPath(); ctx.ellipse(-15+look, -5, 4, 6, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(15+look, -5, 4, 6, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(0+look, 5, 3, 0, Math.PI, false); ctx.stroke();
    ctx.fillStyle = "rgba(255,100,100,0.3)";
    ctx.beginPath(); ctx.arc(-20, 5, 5, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(20, 5, 5, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    // Objects
    entities.forEach(e => {
        ctx.save(); ctx.translate(e.x+e.w/2, e.y+e.h/2); ctx.rotate(e.rot);
        if(e.type === 'coin') {
            ctx.fillStyle = "#ffcc00"; ctx.beginPath(); ctx.arc(0,0,e.w/2,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = "#ffe066"; ctx.beginPath(); ctx.arc(-5,-5,e.w/4,0,Math.PI*2); ctx.fill();
            ctx.strokeStyle = "#e59500"; ctx.stroke();
            ctx.fillStyle = "#d48600"; ctx.font="bold 16px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("$",0,1);
        } else if(e.type === 'bomb') {
            ctx.fillStyle = "#2b2d42"; ctx.beginPath(); ctx.arc(0,0,e.w/2,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = "#ef233c"; ctx.beginPath(); ctx.arc(5,-8,4,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.font="12px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("‚ò†Ô∏è",0,2);
        } else {
            ctx.fillStyle = "#ff8fa3"; ctx.font="24px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("‚ù§Ô∏è",0,0);
        }
        ctx.restore();
    });

    // FX
    particles.forEach(p => {
        ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
    });
    
    floaters.forEach(f => {
        ctx.globalAlpha = f.life; ctx.fillStyle = f.color; ctx.font = "bold 20px Fredoka";
        ctx.strokeStyle = "#000"; ctx.lineWidth = 2; ctx.strokeText(f.text, f.x, f.y); ctx.fillText(f.text, f.x, f.y);
    });
    ctx.globalAlpha = 1.0;
}

// --- MAIN LOOP ---
function loop(timestamp) {
    if (!lastTime) lastTime = timestamp;
    const dt = Math.min((timestamp - lastTime) / 1000, 0.1);
    lastTime = timestamp;

    if (State.screen === 'play') {
        update(dt);
        draw();
    }
    requestAnimationFrame(loop);
}

// --- CONTROLS ---
function setPlayerPos(clientX) {
    const rect = canvas.getBoundingClientRect();
    player.targetX = (clientX - rect.left) * (canvas.width / rect.width / window.devicePixelRatio) - player.w/2;
}
canvas.addEventListener('mousemove', e => { if(State.screen==='play') setPlayerPos(e.clientX); });
canvas.addEventListener('touchmove', e => { e.preventDefault(); if(State.screen==='play') setPlayerPos(e.touches[0].clientX); }, {passive: false});
window.addEventListener('keydown', e => {
    if(State.screen !== 'play') return;
    if(e.key==='ArrowLeft'||e.key==='a') player.targetX -= 40;
    if(e.key==='ArrowRight'||e.key==='d') player.targetX += 40;
});

// --- FLOW ---
function startGame() {
    State.score = 0; State.lives = 3; entities = []; particles = []; floaters = [];
    player.targetX = canvas.logicalWidth/2 - player.w/2; player.x = player.targetX;
    toggleScreen('play'); updateUI(); AudioSys.resume(); AudioSys.startMusic();
}

function endGame() {
    State.coins += State.score;
    if(State.score > State.bestScore) State.bestScore = State.score;
    localStorage.setItem('kittyCatchData', JSON.stringify({ coins: State.coins, bestScore: State.bestScore, inventory: State.inventory, equipped: State.equipped }));
    document.getElementById('uiFinalScore').innerText = State.score;
    document.getElementById('uiBestScore').innerText = State.bestScore;
    toggleScreen('over'); AudioSys.stopMusic();
}

function toggleScreen(name) {
    State.screen = name;
    document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
    document.querySelector('.ui-layer').style.opacity = name === 'play' ? 1 : 0;
    if(name === 'start') document.getElementById('screenStart').classList.remove('hidden');
    if(name === 'shop') document.getElementById('screenShop').classList.remove('hidden');
    if(name === 'over') document.getElementById('screenOver').classList.remove('hidden');
    if(name === 'pause') { document.getElementById('screenPause').classList.remove('hidden'); AudioSys.stopMusic(); }
}

function updateUI() {
    document.getElementById('uiScore').innerText = State.score;
    document.getElementById('uiLives').innerText = "‚ù§Ô∏è".repeat(State.lives) + "üñ§".repeat(3-State.lives);
}

// --- INIT ---
window.onload = () => {
    resize(); AudioSys.init();
    const d = localStorage.getItem('kittyCatchData');
    if(d) { const p=JSON.parse(d); State.coins=p.coins||0; State.bestScore=p.bestScore||0; State.inventory=p.inventory||['classic']; State.equipped=p.equipped||'classic'; }
    window.addEventListener('resize', resize);
    
    document.getElementById('btnPlay').onclick = startGame;
    document.getElementById('btnRestart').onclick = startGame;
    document.getElementById('btnShop').onclick = () => { toggleScreen('shop'); renderShop(); };
    document.getElementById('btnCloseShop').onclick = () => toggleScreen('start');
    document.getElementById('btnHome').onclick = () => toggleScreen('start');
    document.getElementById('btnPause').onclick = () => toggleScreen('pause');
    document.getElementById('btnResume').onclick = () => { toggleScreen('play'); AudioSys.startMusic(); lastTime=performance.now(); };
    document.getElementById('btnQuit').onclick = () => toggleScreen('start');
    document.getElementById('btnMute').onclick = (e) => { 
        State.settings.sound = !State.settings.sound; e.target.innerText = State.settings.sound ? "üéµ" : "üîá"; 
    };
    
    // --- SHOP LOGIC ---
    function renderShop() {
        const grid = document.getElementById('shopGrid');
        grid.innerHTML = "";
        document.getElementById('uiWallet').innerText = State.coins;

        SKINS.forEach(skin => {
            const owned = State.inventory.includes(skin.id);
            const equipped = State.equipped === skin.id;
            
            const el = document.createElement('div');
            el.className = `shop-item ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''} ${!owned && State.coins < skin.cost ? 'locked' : ''}`;
            el.innerHTML = `
                <div style="font-size:2rem; margin-bottom:5px;">üò∫</div>
                <div style="font-weight:bold; color: ${skin.color}; text-shadow: 1px 1px 0 #000;">${skin.name}</div>
                <div style="font-size:0.8rem; color:#666;">${owned ? (equipped ? 'EQUIPPED' : 'OWNED') : 'ü™ô '+skin.cost}</div>
            `;
            el.onclick = () => {
                if (owned) {
                    State.equipped = skin.id;
                    AudioSys.playCoin();
                } else if (State.coins >= skin.cost) {
                    State.coins -= skin.cost;
                    State.inventory.push(skin.id);
                    State.equipped = skin.id;
                    AudioSys.playLife();
                } else {
                    AudioSys.playBomb(); // Error sound
                    return;
                }
                localStorage.setItem('kittyCatchData', JSON.stringify({ coins: State.coins, bestScore: State.bestScore, inventory: State.inventory, equipped: State.equipped }));
                renderShop();
            };
            grid.appendChild(el);
        });
    }

    requestAnimationFrame(loop);
};
</script>
</body>
</html>
