<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üê± Kitty Coin Catcher Deluxe</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        :root {
            --primary: #ff8fab;
            --secondary: #ffc2d1;
            --accent: #fb6f92;
            --text: #594a4e;
            --bg: #ffe5ec;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Fredoka', sans-serif; }

        body {
            background: var(--bg);
            background-image: radial-gradient(var(--secondary) 15%, transparent 16%);
            background-size: 40px 40px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- GAME CONTAINER --- */
        #game-frame {
            position: relative;
            width: 100%; max-width: 450px;
            height: 100%; max-height: 850px;
            background: rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
            border-radius: 0;
            box-shadow: 0 0 50px rgba(251, 111, 146, 0.2);
            overflow: hidden;
        }
        @media(min-width: 500px) {
            #game-frame { height: 90vh; border-radius: 40px; border: 8px solid #fff; }
        }

        /* --- LAYERS --- */
        canvas { display: block; width: 100%; height: 100%; }
        
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            z-index: 10;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; transition: all 0.4s ease;
            pointer-events: auto;
        }
        .hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }

        /* --- HUD --- */
        .hud-top {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; width: 100%;
        }
        
        .score-pill {
            background: #fff; padding: 8px 20px; border-radius: 50px;
            font-size: 1.4rem; font-weight: 700; color: var(--text);
            box-shadow: 0 4px 0 var(--secondary);
            display: flex; gap: 10px; align-items: center;
        }

        .pause-btn {
            background: #fff; width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 0 #ddd;
            border: none; color: var(--text); pointer-events: auto;
        }
        .pause-btn:active { transform: translateY(4px); box-shadow: none; }

        /* Fever Bar */
        .fever-container {
            width: 80%; height: 12px; background: rgba(255,255,255,0.5);
            border-radius: 10px; margin: 0 auto; overflow: hidden;
            border: 2px solid #fff; position: relative;
        }
        .fever-fill {
            height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e, #fad0c4, #fad0c4);
            transition: width 0.2s;
        }
        .fever-active .fever-fill {
            background: linear-gradient(90deg, #ff0000, #ffa500, #ffff00, #008000, #0000ff, #4b0082, #ee82ee);
            animation: rainbow 1s linear infinite;
        }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        /* --- BUTTONS & TYPOGRAPHY --- */
        h1 {
            font-size: 3.5rem; color: var(--accent);
            text-shadow: 3px 3px 0 #fff, 6px 6px 0 var(--secondary);
            text-align: center; line-height: 1.1; margin-bottom: 20px;
        }

        .btn-big {
            background: linear-gradient(180deg, #ff8fab, #fb6f92);
            color: white; border: none; padding: 15px 50px;
            font-size: 1.8rem; border-radius: 50px; font-weight: 700;
            box-shadow: 0 8px 0 #c9184a, 0 15px 20px rgba(251, 111, 146, 0.4);
            cursor: pointer; transition: transform 0.1s; margin: 10px;
            position: relative; overflow: hidden;
        }
        .btn-big:active { transform: translateY(8px); box-shadow: 0 0 0 #c9184a; }
        
        .btn-icon {
            background: #fff; width: 60px; height: 60px; border-radius: 20px;
            border: none; font-size: 1.8rem; box-shadow: 0 5px 0 #ddd;
            color: var(--text); margin: 0 10px; cursor: pointer;
        }
        .btn-icon:active { transform: translateY(5px); box-shadow: none; }

        /* --- LOADING SCREEN --- */
        .loading-screen {
            background: var(--primary); color: white; z-index: 50;
        }
        .loader-cat { font-size: 4rem; animation: bounce 0.6s infinite alternate; }
        .loading-bar {
            width: 200px; height: 10px; background: rgba(255,255,255,0.3);
            border-radius: 10px; margin-top: 20px; overflow: hidden;
        }
        .loading-progress {
            width: 0%; height: 100%; background: #fff;
            animation: load 1.5s ease-out forwards;
        }
        @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        /* --- SHOP --- */
        .shop-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 20px;
        }
        .shop-item {
            width: 60px; height: 60px; border-radius: 15px; background: #f0f0f0;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
            border: 3px solid transparent; cursor: pointer;
        }
        .shop-item.selected { border-color: var(--accent); background: #ffe5ec; }
        .shop-item.locked { opacity: 0.5; filter: grayscale(1); }

    </style>
</head>
<body>

<div id="game-frame">
    
    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer" id="gameUI" style="display:none;">
        <div class="hud-top">
            <button class="pause-btn" onclick="togglePause()">‚è∏Ô∏è</button>
            <div class="score-pill">ü™ô <span id="scoreDisplay">0</span></div>
            <button class="pause-btn" onclick="goHome()">üè†</button>
        </div>
        <div class="fever-container">
            <div class="fever-fill" id="feverBar"></div>
        </div>
        <div style="text-align:center; margin-top: 5px; font-weight:bold; color: var(--accent); text-shadow: 1px 1px 0 #fff;">
            <span id="feverText"></span>
        </div>
    </div>

    <div class="screen" id="startScreen">
        <div style="font-size: 5rem; margin-bottom: 10px;" id="menuCat">üò∫</div>
        <h1>KITTY<br>COIN<br>CATCHER</h1>
        <button class="btn-big" onclick="startLoading()">PLAY ‚ñ∂</button>
        
        <div style="margin-top: 20px; display:flex;">
            <button class="btn-icon" onclick="toggleShop()">üß¢</button>
            <button class="btn-icon" onclick="toggleMute()">üîä</button>
        </div>
        <div style="margin-top: 15px; color: #aaa; font-size: 0.9rem;">High Score: <span id="menuHighScore">0</span></div>
    </div>

    <div class="screen hidden" id="shopScreen">
        <h2>Choose a Hat! üß¢</h2>
        <div style="margin-bottom: 10px; color: var(--text);">Total Coins: <span id="bankDisplay">0</span></div>
        <div class="shop-grid" id="shopGrid">
            </div>
        <button class="btn-big" onclick="closeShop()">CLOSE</button>
    </div>

    <div class="screen hidden loading-screen" id="loadingScreen">
        <div class="loader-cat">üß∂üêà</div>
        <div class="loading-bar"><div class="loading-progress"></div></div>
        <p style="margin-top: 10px; opacity: 0.8;">Chasing lasers...</p>
    </div>

    <div class="screen hidden" id="pauseScreen" style="background: rgba(255,255,255,0.6); backdrop-filter:blur(5px);">
        <h2 style="font-size: 3rem; color: var(--text);">PAUSED</h2>
        <button class="btn-big" onclick="togglePause()">RESUME ‚ñ∂</button>
        <button class="btn-icon" onclick="goHome()" style="margin-top: 20px;">üè†</button>
    </div>

    <div class="screen hidden" id="gameOverScreen">
        <div style="font-size: 4rem;">üòø</div>
        <h2 style="color: var(--accent); font-size: 3rem;">GAME OVER</h2>
        
        <div style="background: #fff; padding: 20px; border-radius: 20px; width: 80%; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin: 20px 0;">
            <div style="font-size: 1rem; color: #888;">SCORE</div>
            <div style="font-size: 3rem; font-weight: 800; color: var(--text);" id="finalScore">0</div>
            <div style="color: gold; margin-top: 5px;" id="newHighScoreTag"></div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="btn-icon" onclick="goHome()">üè†</button>
            <button class="btn-big" onclick="restartGame()">RETRY ‚Ü∫</button>
        </div>
    </div>

</div>

<script>
    /**
     * üê± DELUXE ENGINE
     */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // --- STATE MANAGEMENT ---
    const STATE = {
        MENU: 0,
        LOADING: 1,
        PLAYING: 2,
        PAUSED: 3,
        GAMEOVER: 4,
        SHOP: 5
    };
    let currentState = STATE.MENU;

    // --- GAME VARIABLES ---
    let width, height;
    let frame = 0;
    let score = 0;
    let bank = parseInt(localStorage.getItem('kittyBank')) || 0;
    let highScore = parseInt(localStorage.getItem('kittyHighScore')) || 0;
    let lives = 1; // It's addictive because it's hard! One mistake = over.
    let fever = 0;
    let isFever = false;
    let magnetActive = 0;

    // --- ENTITIES ---
    let player = { x: 0, y: 0, w: 70, h: 60, hat: localStorage.getItem('kittyHat') || 'none' };
    let items = [];
    let particles = [];
    let mouseX = 0;
    
    // --- ASSETS (Emoji based) ---
    const HATS = {
        'none': { icon: '‚ùå', price: 0 },
        'bow': { icon: 'üéÄ', price: 100 },
        'crown': { icon: 'üëë', price: 500 },
        'cool': { icon: 'üòé', price: 1000 },
        'cowboy': { icon: 'ü§†', price: 2000 },
        'astro': { icon: 'üë®‚ÄçüöÄ', price: 5000 }
    };
    let unlockedHats = JSON.parse(localStorage.getItem('kittyUnlocked')) || ['none'];

    // --- SETUP ---
    function resize() {
        const rect = document.getElementById('game-frame').getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        width = canvas.width;
        height = canvas.height;
        player.y = height - 100;
        if(currentState === STATE.MENU) player.x = width/2;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- INPUT ---
    const frameEl = document.getElementById('game-frame');
    function setInput(x) {
        const rect = frameEl.getBoundingClientRect();
        mouseX = x - rect.left;
        if(mouseX < 0) mouseX = 0;
        if(mouseX > width) mouseX = width;
    }
    frameEl.addEventListener('mousemove', e => setInput(e.clientX));
    frameEl.addEventListener('touchmove', e => { e.preventDefault(); setInput(e.touches[0].clientX); }, {passive:false});

    // --- AUDIO SYSTEM (Synthesizer) ---
    const Audio = {
        ctx: null,
        mute: false,
        init: function() {
            if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        },
        play: function(type) {
            if(this.mute || !this.ctx) return;
            if(this.ctx.state === 'suspended') this.ctx.resume();
            
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            const t = this.ctx.currentTime;
            
            osc.connect(gain);
            gain.connect(this.ctx.destination);

            if(type === 'coin') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(isFever ? 1200 : 880, t);
                osc.frequency.exponentialRampToValueAtTime(1600, t+0.1);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t+0.1);
                osc.start(t); osc.stop(t+0.1);
            } else if(type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.linearRampToValueAtTime(50, t+0.3);
                gain.gain.setValueAtTime(0.2, t);
                gain.gain.linearRampToValueAtTime(0, t+0.3);
                osc.start(t); osc.stop(t+0.3);
            } else if(type === 'fever') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(440, t);
                osc.frequency.linearRampToValueAtTime(880, t+0.5);
                gain.gain.setValueAtTime(0.05, t);
                gain.gain.linearRampToValueAtTime(0, t+0.5);
                osc.start(t); osc.stop(t+0.5);
            }
        }
    };

    // --- UI FUNCTIONS ---
    function updateMenu() {
        document.getElementById('menuHighScore').innerText = highScore;
        document.getElementById('menuCat').innerText = player.hat !== 'none' ? HATS[player.hat].icon : 'üò∫';
    }
    
    function startLoading() {
        Audio.init();
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('loadingScreen').classList.remove('hidden');
        currentState = STATE.LOADING;
        
        // Fake loading time
        setTimeout(() => {
            document.getElementById('loadingScreen').classList.add('hidden');
            initGame();
        }, 1600);
    }

    function initGame() {
        score = 0;
        fever = 0;
        isFever = false;
        items = [];
        particles = [];
        magnetActive = 0;
        player.x = width/2;
        mouseX = width/2;
        
        document.getElementById('gameUI').style.display = 'block';
        document.getElementById('scoreDisplay').innerText = '0';
        document.getElementById('feverBar').style.width = '0%';
        document.getElementById('feverContainer').classList.remove('fever-active');
        
        currentState = STATE.PLAYING;
        loop();
    }

    function goHome() {
        currentState = STATE.MENU;
        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('pauseScreen').classList.add('hidden');
        document.getElementById('gameOverScreen').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
        updateMenu();
    }

    function togglePause() {
        if(currentState === STATE.PLAYING) {
            currentState = STATE.PAUSED;
            document.getElementById('pauseScreen').classList.remove('hidden');
        } else if (currentState === STATE.PAUSED) {
            currentState = STATE.PLAYING;
            document.getElementById('pauseScreen').classList.add('hidden');
            loop();
        }
    }

    function restartGame() {
        document.getElementById('gameOverScreen').classList.add('hidden');
        initGame();
    }

    function gameOver() {
        currentState = STATE.GAMEOVER;
        Audio.play('hit');
        
        // Update Bank
        bank += score;
        localStorage.setItem('kittyBank', bank);
        
        // Update High Score
        if(score > highScore) {
            highScore = score;
            localStorage.setItem('kittyHighScore', highScore);
            document.getElementById('newHighScoreTag').innerText = "NEW HIGH SCORE!";
        } else {
            document.getElementById('newHighScoreTag').innerText = "";
        }

        document.getElementById('finalScore').innerText = score;
        document.getElementById('gameOverScreen').classList.remove('hidden');
        document.getElementById('gameUI').style.display = 'none';
    }

    // --- SHOP LOGIC ---
    function toggleShop() {
        const shop = document.getElementById('shopScreen');
        if(currentState === STATE.MENU) {
            currentState = STATE.SHOP;
            shop.classList.remove('hidden');
            renderShop();
        }
    }

    function closeShop() {
        document.getElementById('shopScreen').classList.add('hidden');
        currentState = STATE.MENU;
        updateMenu();
    }

    function renderShop() {
        document.getElementById('bankDisplay').innerText = bank;
        const grid = document.getElementById('shopGrid');
        grid.innerHTML = '';
        
        for(const [key, data] of Object.entries(HATS)) {
            const div = document.createElement('div');
            const unlocked = unlockedHats.includes(key);
            div.className = `shop-item ${player.hat === key ? 'selected' : ''} ${!unlocked ? 'locked' : ''}`;
            div.innerText = data.icon;
            
            div.onclick = () => {
                if(unlocked) {
                    player.hat = key;
                    localStorage.setItem('kittyHat', key);
                    renderShop();
                } else if(bank >= data.price) {
                    bank -= data.price;
                    unlockedHats.push(key);
                    localStorage.setItem('kittyBank', bank);
                    localStorage.setItem('kittyUnlocked', JSON.stringify(unlockedHats));
                    player.hat = key; // Auto equip
                    renderShop();
                } else {
                    div.style.animation = 'shake 0.3s'; // Cant afford
                }
            };
            
            if(!unlocked) {
                const price = document.createElement('div');
                price.style.fontSize = '10px';
                price.style.position = 'absolute';
                price.style.bottom = '2px';
                price.innerText = 'ü™ô' + data.price;
                div.appendChild(price);
                div.style.position = 'relative';
            }
            grid.appendChild(div);
        }
    }

    function toggleMute() {
        Audio.mute = !Audio.mute;
        alert(Audio.mute ? "Sound Muted üîá" : "Sound On üîä");
    }

    // --- GAME LOOP ---
    function spawnItem() {
        const r = Math.random();
        let type = 'coin';
        if(r > 0.98) type = 'magnet';
        else if(r > 0.95) type = 'bag'; // big points
        else if(r < 0.25) type = 'bomb'; // cucumber
        
        items.push({
            x: Math.random() * (width - 40) + 20,
            y: -50,
            type: type,
            speed: Math.random() * 2 + 3 + (score/1000) // gets faster
        });
    }

    function loop() {
        if(currentState !== STATE.PLAYING) return;
        
        ctx.clearRect(0,0,width,height);
        frame++;

        // Spawn
        let spawnRate = isFever ? 15 : 45;
        if(frame % spawnRate === 0) spawnItem();

        // Player Movement
        player.x += (mouseX - player.x) * 0.15;

        // Draw Player
        ctx.save();
        ctx.translate(player.x, player.y);
        
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.beginPath(); ctx.ellipse(0, 30, 30, 10, 0, 0, Math.PI*2); ctx.fill();

        // Cat Body
        ctx.fillStyle = isFever ? `hsl(${frame%360}, 100%, 80%)` : '#fff';
        ctx.beginPath(); ctx.ellipse(0, 0, 40, 35, 0, 0, Math.PI*2); ctx.fill();
        
        // Ears
        ctx.beginPath(); ctx.moveTo(-30,-20); ctx.lineTo(-40,-45); ctx.lineTo(-10,-30); ctx.fill();
        ctx.beginPath(); ctx.moveTo(30,-20); ctx.lineTo(40,-45); ctx.lineTo(10,-30); ctx.fill();
        
        // Face
        ctx.fillStyle = '#594a4e';
        ctx.beginPath(); ctx.arc(-15, -5, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(15, -5, 4, 0, Math.PI*2); ctx.fill();
        // Mouth
        ctx.beginPath(); ctx.arc(0, 5, 5, 0, Math.PI); ctx.stroke();
        
        // Hat
        if(player.hat !== 'none') {
            ctx.font = '40px Fredoka';
            ctx.textAlign = 'center';
            ctx.fillText(HATS[player.hat].icon, 0, -35);
        }
        
        // Magnet Visual
        if(magnetActive > 0) {
            ctx.strokeStyle = '#8ecae6';
            ctx.lineWidth = 3;
            ctx.beginPath(); ctx.arc(0,0, 60, 0, Math.PI*2); ctx.stroke();
            magnetActive--;
        }

        ctx.restore();

        // Items Logic
        for(let i=items.length-1; i>=0; i--) {
            let it = items[i];
            
            // Magnet Effect
            if(magnetActive > 0 && it.type !== 'bomb') {
                it.x += (player.x - it.x) * 0.1;
                it.y += (player.y - it.y) * 0.1;
            } else {
                it.y += it.speed;
            }

            // Draw Item
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            let icon = 'ü™ô';
            if(it.type === 'bomb') icon = 'ü•í';
            if(it.type === 'magnet') icon = 'üß≤';
            if(it.type === 'bag') icon = 'üí∞';
            ctx.fillText(icon, it.x, it.y);

            // Collision
            let dx = player.x - it.x;
            let dy = player.y - it.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            
            if(dist < 50) {
                if(it.type === 'bomb') {
                    if(!isFever) { // Invincible during fever
                        gameOver();
                        return; 
                    }
                } else {
                    // Collect
                    Audio.play('coin');
                    let pts = 10;
                    if(it.type === 'bag') pts = 100;
                    if(isFever) pts *= 2;
                    
                    score += pts;
                    
                    if(it.type === 'magnet') magnetActive = 300; // 5 secs

                    // Fever Logic
                    if(!isFever) {
                        fever += 10;
                        document.getElementById('feverBar').style.width = fever + '%';
                        if(fever >= 100) {
                            isFever = true;
                            magnetActive = 600; // 10s magnet during fever
                            Audio.play('fever');
                            document.getElementById('feverContainer').classList.add('fever-active');
                            document.getElementById('feverText').innerText = "FEVER MODE! x2 POINTS";
                            setTimeout(() => {
                                isFever = false;
                                fever = 0;
                                document.getElementById('feverContainer').classList.remove('fever-active');
                                document.getElementById('feverText').innerText = "";
                            }, 5000);
                        }
                    }
                }
                items.splice(i, 1);
            } else if (it.y > height + 20) {
                items.splice(i, 1);
            }
        }
        
        document.getElementById('scoreDisplay').innerText = score;
        requestAnimationFrame(loop);
    }

    // Init Menu
    updateMenu();

</script>
</body>
</html>
